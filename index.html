<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AppFLO">
    <meta name="application-name" content="AppFLO">
    <meta name="theme-color" content="#667eea">
    <meta name="msapplication-TileColor" content="#667eea">
    <title>AppFLO - Five Point Test</title>
    
    <!-- iOS App Icon (PNG base64) -->
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAA9zQYyAAAC+ElEQVR42u3d0U0DQRAFwYuWMAiYJEAOAYx9sz21UifwKPlrb7mu4efj8+tbs7ocYIEHWIBDLLhBFtggKw/bH0gZ2P4oSqD2h1AGtvGVQW10ZVAbWxnURlYGtXGVQW1UZVAbUxnURlQKtQGVAW08ZVAbTSnUBlMGtLGUQm0oZUAbSSnUBlIGtHGUQm0YAS1NBG0UpVAbREDf1OP4A9r5SNC/ORDu3nk05mcOoHt3Hgf6Pw+w+3YeBfoVB95dO48B/coD8Z6dR4B+x4F5x85AAw30aSNDvWdnoIFugd4y8mbUm3YGGmigDQ000EDbGWig7XwI6DsPzN2d/UJD7Rfa0EADDbSdgQbazkADDbQ7BlC7y2FooIF2H9rOQANt55NA+6bQzjnQvvq2cw60dznsnAPt5SQ7J0F7287OSdBeH7VzHrQEtICWgJaAloCWgBbQEtAS0BLQEtACWgJaAtpVTAHtsryA9jkT0PJhL9AwQw30SsxQA53DDDXQQAvoyZihBhpoAT0ZM9RAAw20EYAGGmiggQYaaKCXY4YaaL/QQAtooIEGGmiggQYaaAHtLgfQAhpoqGEGGmiggfZNoYD21TfQ8i4H0AIZaLDtBfSxyO0AtAS0gJaAloCWgJaAFtAS0BLQEtAS0AJaAloC2lVMO+8C7bK8nROgfc5k5wRoH5zaOQPakwB2zoD2aIudM6A9q2VnoIG280TQnqa1M9BA23kiaP/ewc5AA21noIEG2tBAA21ooJeCvvPA3N3ZLzTUfqENDTTQQNsZaKDtDDTQm0E/jjsGUGfucgANNNDu6UI99T400EAD7Vs3qIfuPAa0r77tnAPtXQ4750B7OcnOT4Oeitrbdnb+E+bJoL0+auc8aAlo7QINtVKYgRbQ0mTQUCuFGWjlQEOtFGaglQMNtVKYgVYONNRKYYZaOcxAKwcaaqUwQ60cZqiVwwy1cpihVg4z1Mphhlo5zFArhxls5SBDrSRmsJWDDLaSkMFWEjLcSiIGHOB3nR+YUeFIVPQLbgAAAABJRU5ErkJggg==">
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAA9zQYyAAAC+ElEQVR42u3d0U0DQRAFwYuWMAiYJEAOAYx9sz21UifwKPlrb7mu4efj8+tbs7ocYIEHWIBDLLhBFtggKw/bH0gZ2P4oSqD2h1AGtvGVQW10ZVAbWxnURlYGtXGVQW1UZVAbUxnURlQKtQGVAW08ZVAbTSnUBlMGtLGUQm0oZUAbSSnUBlIGtHGUQm0YAS1NBG0UpVAbREDf1OP4A9r5SNC/ORDu3nk05mcOoHt3Hgf6Pw+w+3YeBfoVB95dO48B/coD8Z6dR4B+x4F5x85AAw30aSNDvWdnoIFugd4y8mbUm3YGGmigDQ000EDbGWig7XwI6DsPzN2d/UJD7Rfa0EADDbSdgQbazkADDbQ7BlC7y2FooIF2H9rOQANt55NA+6bQzjnQvvq2cw60dznsnAPt5SQ7J0F7287OSdBeH7VzHrQEtICWgJaAloCWgBbQEtAS0BLQEtACWgJaAtpVTAHtsryA9jkT0PJhL9AwQw30SsxQA53DDDXQQAvoyZihBhpoAT0ZM9RAAw20EYAGGmiggQYaaKCXY4YaaL/QQAtooIEGGmiggQYaaAHtLgfQAhpoqGEGGmiggfZNoYD21TfQ8i4H0AIZaLDtBfSxyO0AtAS0gJaAloCWgJaAFtAS0BLQEtAS0AJaAloC2lVMO+8C7bK8nROgfc5k5wRoH5zaOQPakwB2zoD2aIudM6A9q2VnoIG280TQnqa1M9BA23kiaP/ewc5AA21noIEG2tBAA21ooJeCvvPA3N3ZLzTUfqENDTTQQNsZaKDtDDTQm0E/jjsGUGfucgANNNDu6UI99T400EAD7Vs3qIfuPAa0r77tnAPtXQ4750B7OcnOT4Oeitrbdnb+E+bJoL0+auc8aAlo7QINtVKYgRbQ0mTQUCuFGWjlQEOtFGaglQMNtVKYgVYONNRKYYZaOcxAKwcaaqUwQ60cZqiVwwy1cpihVg4z1Mphhlo5zFArhxls5SBDrSRmsJWDDLaSkMFWEjLcSiIGHOB3nR+YUeFIVPQLbgAAAABJRU5ErkJggg==">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAA9zQYyAAAC+ElEQVR42u3d0U0DQRAFwYuWMAiYJEAOAYx9sz21UifwKPlrb7mu4efj8+tbs7ocYIEHWIBDLLhBFtggKw/bH0gZ2P4oSqD2h1AGtvGVQW10ZVAbWxnURlYGtXGVQW1UZVAbUxnURlQKtQGVAW08ZVAbTSnUBlMGtLGUQm0oZUAbSSnUBlIGtHGUQm0YAS1NBG0UpVAbREDf1OP4A9r5SNC/ORDu3nk05mcOoHt3Hgf6Pw+w+3YeBfoVB95dO48B/coD8Z6dR4B+x4F5x85AAw30aSNDvWdnoIFugd4y8mbUm3YGGmigDQ000EDbGWig7XwI6DsPzN2d/UJD7Rfa0EADDbSdgQbazkADDbQ7BlC7y2FooIF2H9rOQANt55NA+6bQzjnQvvq2cw60dznsnAPt5SQ7J0F7287OSdBeH7VzHrQEtICWgJaAloCWgBbQEtAS0BLQEtACWgJaAtpVTAHtsryA9jkT0PJhL9AwQw30SsxQA53DDDXQQAvoyZihBhpoAT0ZM9RAAw20EYAGGmiggQYaaKCXY4YaaL/QQAtooIEGGmiggQYaaAHtLgfQAhpoqGEGGmiggfZNoYD21TfQ8i4H0AIZaLDtBfSxyO0AtAS0gJaAloCWgJaAFtAS0BLQEtAS0AJaAloC2lVMO+8C7bK8nROgfc5k5wRoH5zaOQPakwB2zoD2aIudM6A9q2VnoIG280TQnqa1M9BA23kiaP/ewc5AA21noIEG2tBAA21ooJeCvvPA3N3ZLzTUfqENDTTQQNsZaKDtDDTQm0E/jjsGUGfucgANNNDu6UI99T400EAD7Vs3qIfuPAa0r77tnAPtXQ4750B7OcnOT4Oeitrbdnb+E+bJoL0+auc8aAlo7QINtVKYgRbQ0mTQUCuFGWjlQEOtFGaglQMNtVKYgVYONNRKYYZaOcxAKwcaaqUwQ60cZqiVwwy1cpihVg4z1Mphhlo5zFArhxls5SBDrSRmsJWDDLaSkMFWEjLcSiIGHOB3nR+YUeFIVPQLbgAAAABJRU5ErkJggg==">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        html {
            -webkit-text-size-adjust: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 10px;
            touch-action: none;
            -webkit-overflow-scrolling: touch;
        }

        /* ==================== SPLASH SCREEN ==================== */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.5s, visibility 0.5s;
        }

        .splash-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .splash-logo {
            width: 120px;
            height: 120px;
            background: rgba(255,255,255,0.2);
            border-radius: 24px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            padding: 20px;
            margin-bottom: 30px;
            animation: pulse 2s ease-in-out infinite;
        }

        .splash-logo .dot {
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            animation: dotPulse 1.5s ease-in-out infinite;
        }

        .splash-logo .dot:nth-child(1) { grid-area: 1 / 1; animation-delay: 0s; }
        .splash-logo .dot:nth-child(2) { grid-area: 1 / 3; animation-delay: 0.1s; }
        .splash-logo .dot:nth-child(3) { grid-area: 2 / 2; animation-delay: 0.2s; }
        .splash-logo .dot:nth-child(4) { grid-area: 3 / 1; animation-delay: 0.3s; }
        .splash-logo .dot:nth-child(5) { grid-area: 3 / 3; animation-delay: 0.4s; }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes dotPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(0.9); }
        }

        .splash-title {
            color: white;
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .splash-subtitle {
            color: rgba(255,255,255,0.8);
            font-size: 16px;
            margin-bottom: 40px;
        }

        .splash-loader {
            width: 200px;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            overflow: hidden;
        }

        .splash-loader-bar {
            height: 100%;
            background: white;
            border-radius: 2px;
            animation: loading 2s ease-in-out;
        }

        @keyframes loading {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        /* ==================== LANGUAGE & SOUND TOGGLES ==================== */
        .language-toggle {
            position: fixed;
            top: 15px;
            right: 15px;
            display: none;
            gap: 5px;
            z-index: 9999;
            background: white;
            padding: 5px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .lang-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            background: transparent;
            color: #666;
        }

        .lang-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .sound-toggle {
            position: fixed;
            top: 15px;
            left: 15px;
            display: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            font-size: 20px;
            z-index: 9999;
        }

        /* ==================== CONSENT SCREEN ==================== */
        .consent-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            justify-content: center;
            align-items: center;
            padding: 20px;
            z-index: 9000;
        }

        .consent-card {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .consent-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            text-align: center;
            border-radius: 16px 16px 0 0;
        }

        .consent-header h2 {
            margin-bottom: 5px;
            font-size: 24px;
        }

        .consent-body {
            padding: 25px;
        }

        .consent-section {
            margin-bottom: 20px;
        }

        .consent-section h3 {
            color: #667eea;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .consent-section p, .consent-section ul {
            font-size: 14px;
            color: #555;
            line-height: 1.6;
        }

        .consent-section ul {
            margin-left: 20px;
        }

        .consent-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .consent-checkbox input {
            width: 20px;
            height: 20px;
            margin-top: 2px;
        }

        .consent-checkbox label {
            font-size: 14px;
            color: #333;
            cursor: pointer;
        }

        .consent-buttons {
            display: flex;
            gap: 15px;
            padding: 20px 25px;
            border-top: 1px solid #e0e0e0;
        }

        .consent-btn {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .consent-btn.decline {
            background: #f5f5f5;
            color: #666;
        }

        .consent-btn.agree {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .consent-btn.agree:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ==================== PROGRESS BAR ==================== */
        .progress-container {
            display: none;
            margin-bottom: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 1s linear;
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, #ff9800, #f57c00);
        }

        .progress-fill.critical {
            background: linear-gradient(90deg, #f44336, #d32f2f);
            animation: pulse-bar 0.5s ease-in-out infinite;
        }

        @keyframes pulse-bar {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        /* ==================== RESULTS SCREEN ==================== */
        .results-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            justify-content: center;
            align-items: center;
            padding: 20px;
            z-index: 8000;
        }

        .results-card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .results-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            padding: 12px;
            margin: 0 auto 20px;
        }

        .results-logo .dot {
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
        }

        .results-logo .dot:nth-child(1) { grid-area: 1 / 1; }
        .results-logo .dot:nth-child(2) { grid-area: 1 / 3; }
        .results-logo .dot:nth-child(3) { grid-area: 2 / 2; }
        .results-logo .dot:nth-child(4) { grid-area: 3 / 1; }
        .results-logo .dot:nth-child(5) { grid-area: 3 / 3; }

        .results-title {
            font-size: 28px;
            color: #333;
            margin-bottom: 10px;
        }

        .results-name {
            font-size: 18px;
            color: #666;
            margin-bottom: 30px;
        }

        .results-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .results-stat {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
        }

        .results-stat-value {
            font-size: 36px;
            font-weight: 700;
            color: #667eea;
        }

        .results-stat-label {
            font-size: 14px;
            color: #666;
        }

        .results-buttons {
            display: flex;
            gap: 15px;
        }

        .results-btn {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .results-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .results-btn.secondary {
            background: #f5f5f5;
            color: #333;
        }

        /* ==================== INLINE LOGO ==================== */
        .inline-logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: inline-grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            padding: 8px;
            vertical-align: middle;
            margin-right: 10px;
        }

        .inline-logo .dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
        }

        .inline-logo .dot:nth-child(1) { grid-area: 1 / 1; }
        .inline-logo .dot:nth-child(2) { grid-area: 1 / 3; }
        .inline-logo .dot:nth-child(3) { grid-area: 2 / 2; }
        .inline-logo .dot:nth-child(4) { grid-area: 3 / 1; }
        .inline-logo .dot:nth-child(5) { grid-area: 3 / 3; }

        /* ==================== TIMER COLORS ==================== */
        .timer.warning {
            color: #ff9800 !important;
        }

        .timer.critical {
            color: #f44336 !important;
            animation: pulse-timer 0.5s ease-in-out infinite;
        }

        @keyframes pulse-timer {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* ==================== ADMIN LOGIN MODAL ==================== */
        .admin-login-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 9500;
            backdrop-filter: blur(5px);
        }

        .admin-login-modal.active {
            display: flex;
        }

        .admin-login-card {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .admin-login-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .admin-login-header h2 {
            margin: 0;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .admin-login-body {
            padding: 30px;
        }

        .admin-login-body .form-group {
            margin-bottom: 20px;
        }

        .admin-login-body label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .admin-login-body input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .admin-login-body input:focus {
            outline: none;
            border-color: #667eea;
        }

        .admin-login-error {
            color: #f44336;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }

        .admin-login-error.show {
            display: block;
        }

        .admin-login-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .admin-login-btn {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .admin-login-btn.cancel {
            background: #f5f5f5;
            color: #666;
        }

        .admin-login-btn.cancel:hover {
            background: #e0e0e0;
        }

        .admin-login-btn.login {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .admin-login-btn.login:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: none; /* Hidden initially until sign-in */
        }

        h1 {
            color: #333;
            margin-bottom: 5px;
            font-size: 24px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .info {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
            line-height: 1.5;
        }

        .info strong {
            color: #1976D2;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: #2196F3;
            color: white;
        }

        .btn-primary:hover {
            background: #1976D2;
        }

        .btn-secondary {
            background: #4CAF50;
            color: white;
        }

        .btn-secondary:hover {
            background: #45a049;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #da190b;
        }

        .btn-disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .timer {
            font-size: 32px;
            font-weight: bold;
            color: #2196F3;
            text-align: center;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
        }

        .timer.warning {
            color: #ff9800;
        }

        .timer.danger {
            color: #f44336;
        }

        .canvas-container {
            position: relative;
            margin: 15px 0;
            display: flex;
            justify-content: center;
        }

        canvas {
            border: 2px solid #ddd;
            border-radius: 4px;
            cursor: crosshair;
            touch-action: none;
            background: white;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .stat-card {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .designs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 8px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: #fafafa;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .design-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
            background: white;
            position: relative;
            aspect-ratio: 1;
        }

        .design-item.duplicate {
            border-color: #f44336;
            background: #ffebee;
        }

        .design-item canvas {
            width: 100%;
            height: 100%;
            border: none;
        }

        .design-number {
            position: absolute;
            top: 2px;
            left: 2px;
            background: rgba(0,0,0,0.7);
            color: white;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 3px;
        }

        .duplicate-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #f44336;
            color: white;
            font-size: 9px;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .current-box-indicator {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #2196F3;
            margin: 10px 0;
        }

        .instructions {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin: 15px 0;
            font-size: 13px;
        }

        .instructions ul {
            margin-left: 20px;
            margin-top: 8px;
        }

        .instructions li {
            margin-bottom: 5px;
        }

        /* Custom modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 25px;
        }

        .modal-btn {
            padding: 12px 30px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .modal-btn-yes {
            background: #4CAF50;
            color: white;
        }

        .modal-btn-yes:hover {
            background: #45a049;
        }

        .modal-btn-cancel {
            background: #999;
            color: white;
        }

        .modal-btn-cancel:hover {
            background: #777;
        }

        /* Sign-in screen styles */
        .signin-screen {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .signin-screen.hidden {
            display: none;
        }

        .signin-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 450px;
            width: 90%;
        }

        .signin-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .signin-header h1 {
            font-size: 28px;
            color: #333;
            margin-bottom: 10px;
        }

        .signin-header p {
            color: #666;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group input.error {
            border-color: #f44336;
        }

        .error-message {
            color: #f44336;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .signin-btn {
            width: 100%;
            padding: 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 10px;
        }

        .signin-btn:hover {
            background: #5568d3;
        }

        .signin-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .user-info-display {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
            text-align: center;
        }

        .user-info-display strong {
            color: #1976D2;
        }

        /* Autocomplete suggestions */
        .autocomplete-container {
            position: relative;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .autocomplete-suggestions.show {
            display: block;
        }

        .autocomplete-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover {
            background: #f5f5f5;
        }

        .autocomplete-item.selected {
            background: #e3f2fd;
        }

        .no-results {
            padding: 12px;
            color: #999;
            text-align: center;
            font-size: 14px;
        }

        /* Violation prompt styles */
        .violation-prompt {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            max-width: 500px;
            width: 90%;
            z-index: 3000;
            text-align: center;
        }

        .violation-prompt.active {
            display: block;
        }

        .violation-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2999;
        }

        .violation-overlay.active {
            display: block;
        }

        .violation-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .violation-title {
            font-size: 20px;
            font-weight: bold;
            color: #f44336;
            margin-bottom: 10px;
        }

        .violation-message {
            font-size: 16px;
            color: #333;
            line-height: 1.6;
            margin-bottom: 20px;
            white-space: pre-line;
            text-align: left;
        }

        .violation-btn {
            padding: 12px 30px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .violation-btn:hover {
            background: #1976D2;
        }

        .violation-timer {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
        }

        /* Screen lock overlay */
        .screen-lock {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 4000;
            align-items: center;
            justify-content: center;
        }

        .screen-lock.active {
            display: flex;
        }

        .end-test-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            max-width: 450px;
            width: 90%;
            text-align: center;
        }

        .end-test-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .end-test-title {
            font-size: 28px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .end-test-message {
            font-size: 16px;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .end-test-btn {
            width: 100%;
            padding: 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .end-test-btn:hover {
            background: #45a049;
        }

        /* Admin Dashboard */
        .admin-dashboard {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .admin-dashboard.active {
            display: block;
        }

        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .admin-header h2 {
            margin: 0;
            font-size: 28px;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .admin-stat-card {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .admin-stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .admin-stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }

        .admin-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }

        .data-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table tr:hover {
            background: #f5f5f5;
        }

        /* Folder structure styles */
        .breadcrumb {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .folder-view {
            margin-top: 20px;
        }

        .folders-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .folder-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .folder-item:hover {
            border-color: #667eea;
            background: #f5f5ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .folder-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .folder-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .folder-info {
            font-size: 12px;
            color: #666;
        }

        .session-metadata {
            background: #f9f9f9;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .session-metadata h4 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .session-metadata p {
            margin: 5px 0;
            font-size: 14px;
            color: #666;
        }

        .designs-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .design-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s;
        }

        .design-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .design-card.violation {
            border-color: #f44336;
            background: #fff5f5;
        }

        .design-card.spatial-strategy {
            border-color: #2196F3;
            border-width: 3px;
            background: #e3f2fd;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.3);
        }

        .design-card.numerical-strategy {
            border-color: #4CAF50;
            border-width: 3px;
            background: #e8f5e9;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }

        .design-card.first-original {
            border-color: #FFC107;
            border-width: 3px;
            background: #fffde7;
            box-shadow: 0 0 10px rgba(255, 193, 7, 0.3);
        }

        .spatial-badge {
            background: #2196F3;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 5px;
        }

        .numerical-badge {
            background: #4CAF50;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 5px;
        }

        .original-badge {
            background: #FFC107;
            color: #333;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 5px;
        }

        /* Export Modal Styles */
        .export-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .export-modal-overlay.active {
            display: flex;
        }

        .export-modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .export-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 16px 16px 0 0;
            position: relative;
        }

        .export-modal-header h2 {
            margin: 0 0 5px 0;
            font-size: 24px;
        }

        .export-modal-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 14px;
        }

        .export-close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .export-close-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .export-options {
            padding: 25px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 700px) {
            .export-options {
                grid-template-columns: 1fr;
            }
        }

        .export-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .export-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .spss-card {
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
        }

        .other-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
        }

        .export-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .export-card h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 18px;
        }

        .export-description {
            color: #666;
            font-size: 13px;
            margin-bottom: 12px;
        }

        .export-features {
            list-style: none;
            padding: 0;
            margin: 0 0 15px 0;
            font-size: 12px;
            color: #555;
        }

        .export-features li {
            padding: 4px 0;
            color: #2e7d32;
        }

        .export-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .export-btn {
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            text-align: left;
            display: flex;
            flex-direction: column;
        }

        .export-btn .btn-subtitle {
            font-size: 11px;
            font-weight: 400;
            opacity: 0.8;
            margin-top: 3px;
        }

        .spss-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .spss-btn:hover {
            background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
            transform: translateX(5px);
        }

        .json-btn {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
        }

        .json-btn:hover {
            background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
            transform: translateX(5px);
        }

        .csv-btn {
            background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
            color: white;
        }

        .csv-btn:hover {
            background: linear-gradient(135deg, #7B1FA2 0%, #6A1B9A 100%);
            transform: translateX(5px);
        }

        .export-footer {
            background: #f8f9fa;
            padding: 15px 25px;
            border-radius: 0 0 16px 16px;
            border-top: 1px solid #e0e0e0;
        }

        .export-footer p {
            margin: 0;
            font-size: 13px;
            color: #666;
        }

        .design-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .design-number {
            font-weight: bold;
            color: #667eea;
            font-size: 16px;
        }

        .violation-badge {
            background: #f44336;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .design-canvas-container {
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .design-canvas-container canvas {
            max-width: 100%;
            height: auto;
        }

        .design-info {
            font-size: 12px;
            color: #666;
            line-height: 1.6;
        }

        .design-info strong {
            color: #333;
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 20px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .modal-buttons {
                flex-direction: column;
            }

            .modal-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- SPLASH SCREEN -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-logo">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
        </div>
        <div class="splash-title">AppFLO</div>
        <div class="splash-subtitle">Five Point Test - Fluence Graphique</div>
        <div class="splash-loader">
            <div class="splash-loader-bar"></div>
        </div>
    </div>

    <!-- GLOBAL LANGUAGE TOGGLE (visible on all screens) -->
    <div class="language-toggle" id="languageToggle">
        <button class="lang-btn active" data-lang="en">EN</button>
        <button class="lang-btn" data-lang="fr">FR</button>
    </div>

    <!-- GLOBAL SOUND TOGGLE (visible on all screens) -->
    <button class="sound-toggle" id="soundToggle">ðŸ”Š</button>

    <!-- CONSENT SCREEN -->
    <div class="consent-screen" id="consentScreen">
        <div class="consent-card">
            <div class="consent-header">
                <h2 data-i18n="consent-title">Research Consent</h2>
                <p data-i18n="consent-subtitle">Five Point Test Assessment</p>
            </div>
            <div class="consent-body">
                <div class="consent-section">
                    <h3 data-i18n="consent-purpose-title">Purpose</h3>
                    <p data-i18n="consent-purpose-text">This assessment measures figural fluency and creative design abilities using the Five Point Test methodology.</p>
                </div>
                <div class="consent-section">
                    <h3 data-i18n="consent-procedure-title">Procedure</h3>
                    <p data-i18n="consent-procedure-text">You will be asked to create as many unique designs as possible by connecting dots within a 5-minute period.</p>
                </div>
                <div class="consent-section">
                    <h3 data-i18n="consent-data-title">Data Collection</h3>
                    <p data-i18n="consent-data-text">Your designs, timing data, and basic demographic information will be collected for analysis.</p>
                </div>
                <div class="consent-section">
                    <h3 data-i18n="consent-rights-title">Your Rights</h3>
                    <ul>
                        <li data-i18n="consent-rights-1">Participation is voluntary</li>
                        <li data-i18n="consent-rights-2">You may stop at any time without penalty</li>
                        <li data-i18n="consent-rights-3">You may request your data be deleted</li>
                    </ul>
                </div>
                <div class="consent-checkbox">
                    <input type="checkbox" id="consentCheckbox">
                    <label for="consentCheckbox" data-i18n="consent-checkbox-label">I have read and understood the information above. I voluntarily agree to participate in this assessment.</label>
                </div>
            </div>
            <div class="consent-buttons">
                <button class="consent-btn decline" onclick="declineConsent()" data-i18n="consent-decline">Decline</button>
                <button class="consent-btn agree" id="agreeBtn" onclick="acceptConsent()" disabled data-i18n="consent-agree">I Agree</button>
            </div>
        </div>
    </div>

    <!-- RESULTS SCREEN -->
    <div class="results-screen" id="resultsScreen">
        <div class="results-card">
            <div class="results-logo">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
            <h2 class="results-title" data-i18n="results-title">Test Complete!</h2>
            <p class="results-name"><span id="resultName"></span></p>
            <p style="color: #666; margin-bottom: 30px;" data-i18n="results-thanks">Thank you for your participation!</p>
            <div class="results-buttons">
                <button class="results-btn primary" onclick="newParticipant()" data-i18n="results-new">New Participant</button>
            </div>
        </div>
    </div>

    <!-- ADMIN LOGIN MODAL -->
    <div class="admin-login-modal" id="adminLoginModal">
        <div class="admin-login-card">
            <div class="admin-login-header">
                <h2>ðŸ” Admin Login</h2>
            </div>
            <div class="admin-login-body">
                <div class="form-group">
                    <label for="adminPassword" data-i18n="admin-password">Password</label>
                    <input type="password" id="adminPassword" placeholder="Enter admin password" onkeypress="if(event.key==='Enter') attemptAdminLogin()">
                </div>
                <div class="admin-login-error" id="adminLoginError" data-i18n="admin-error">Incorrect password. Please try again.</div>
                <div class="admin-login-buttons">
                    <button class="admin-login-btn cancel" onclick="hideAdminLogin()" data-i18n="admin-cancel">Cancel</button>
                    <button class="admin-login-btn login" onclick="attemptAdminLogin()" data-i18n="admin-login">Login</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sign-in Screen -->
    <div class="signin-screen" id="signinScreen" style="display: none;">
        <div class="signin-card">
            <div class="signin-header">
                <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 10px;">
                    <div class="inline-logo">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                    <h1>AppFLO</h1>
                </div>
                <p data-i18n="signin-subtitle">Please enter your information to begin</p>
            </div>
            <form id="signinForm" onsubmit="handleSignIn(event)">
                <div class="form-group autocomplete-container">
                    <label for="firstName" data-i18n="signin-firstname">First Name *</label>
                    <input type="text" id="firstName" name="firstName" autocomplete="off" required>
                    <div class="autocomplete-suggestions" id="firstNameSuggestions"></div>
                    <span class="error-message" id="firstNameError" data-i18n="signin-firstname-error">Please enter your first name</span>
                </div>
                <div class="form-group autocomplete-container">
                    <label for="lastName" data-i18n="signin-lastname">Last Name *</label>
                    <input type="text" id="lastName" name="lastName" autocomplete="off" required>
                    <div class="autocomplete-suggestions" id="lastNameSuggestions"></div>
                    <span class="error-message" id="lastNameError" data-i18n="signin-lastname-error">Please enter your last name</span>
                </div>
                <div class="form-group">
                    <label for="age" data-i18n="signin-age">Age *</label>
                    <input type="number" id="age" name="age" min="6" max="12" required>
                    <span class="error-message" id="ageError" data-i18n="signin-age-error">Please enter a valid age (6-12 years)</span>
                </div>
                <button type="submit" class="signin-btn" data-i18n="signin-btn">Begin Test</button>
            </form>
        </div>
    </div>

    <div class="container">
        <h1 data-i18n="test-title">AppFLO</h1>
        <div class="subtitle" data-i18n="test-subtitle">Five Point Test - Fluence Graphique</div>
        
        <div class="user-info-display" id="userInfoDisplay" style="display: none;">
            <strong>Participant:</strong> <span id="displayName"></span> | <strong>Age:</strong> <span id="displayAge"></span>
        </div>
        
        <div class="info">
            <strong data-i18n="test-objective">Create as many different designs as possible by connecting 2 or more dots with straight lines.</strong>
            <br><span data-i18n="test-duration">Duration:</span> <strong data-i18n="test-duration-value">5 minutes</strong>.
            <br><em data-i18n="test-note">Note: When you connect all 5 dots, the design auto-saves after 1 second. You can also press "Next Design" anytime.</em>
            <br><em>ðŸ’¾ <span data-i18n="test-memory">Memory: The app saves all designs you create across sessions!</span></em>
        </div>

        <div class="instructions">
            <strong data-i18n="test-rules-title">Rules:</strong>
            <ul>
                <li data-i18n="test-rule-1">Connect 5 dots per design only</li>
                <li data-i18n="test-rule-2">Use only straight lines between dots</li>
                <li data-i18n="test-rule-3">Each design must be different from all previous ones</li>
                <li data-i18n="test-rule-4">Work as quickly as possible within the time limit</li>
            </ul>
        </div>

        <div class="controls">
            <button id="startBtn" class="btn-primary" onclick="startTest()" data-i18n="test-start-btn">Start Test (5 min)</button>
            <button id="clearBtn" class="btn-secondary" onclick="clearCurrentDesign()" data-i18n="test-clear-btn">Clear Current</button>
            <button id="nextBtn" class="btn-primary" onclick="nextDesign()" data-i18n="test-next-btn">Next Design â†’</button>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 100%;"></div>
            </div>
            <div class="progress-text">
                <span data-i18n="progress-remaining">Time Remaining</span>
                <span id="progressPercent">100%</span>
            </div>
        </div>

        <div class="timer" id="timer">05:00</div>

        <div class="canvas-container">
            <canvas id="mainCanvas"></canvas>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-label" data-i18n="test-total-designs">Total Designs</div>
                <div class="stat-value" id="totalCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label" data-i18n="test-current-box">Current Box</div>
                <div class="stat-value" id="currentBox">1</div>
            </div>
        </div>

        <h3 style="margin-top: 20px; color: #333;" data-i18n="test-completed-designs">Completed Designs:</h3>
        <div class="designs-grid" id="designsGrid"></div>
    </div>

    <!-- Admin Dashboard -->
    <div class="admin-dashboard" id="adminDashboard">
        <div class="admin-header">
            <h2>ðŸ” Admin Dashboard</h2>
            <p>View all stored design data and analytics</p>
        </div>

        <div class="admin-stats">
            <div class="admin-stat-card">
                <div class="admin-stat-label">Total Designs</div>
                <div class="admin-stat-value" id="adminTotalDesigns">0</div>
            </div>
            <div class="admin-stat-card">
                <div class="admin-stat-label">Total Participants</div>
                <div class="admin-stat-value" id="adminTotalParticipants">0</div>
            </div>
            <div class="admin-stat-card">
                <div class="admin-stat-label">Total Sessions</div>
                <div class="admin-stat-value" id="adminTotalSessions">0</div>
            </div>
        </div>

        <div class="admin-actions">
            <button class="btn-primary" onclick="showExportModal()">ðŸ“Š Export Data</button>
            <button class="btn-danger" onclick="clearAllData()">Clear All Data</button>
            <button class="btn-secondary" onclick="logoutAdmin()">Logout</button>
        </div>

        <!-- Breadcrumb Navigation -->
        <div class="breadcrumb" id="breadcrumb">
            <span onclick="showParticipantsView()" style="cursor: pointer; color: #667eea;">ðŸ“ All Participants</span>
            <span id="breadcrumbPath"></span>
        </div>

        <!-- Participants View -->
        <div id="participantsView" class="folder-view">
            <h3>All Participants</h3>
            <div id="participantsList" class="folders-container"></div>
        </div>

        <!-- Designs View -->
        <div id="designsView" class="folder-view" style="display: none;">
            <h3 id="designsTitle">Designs</h3>
            <button class="btn-secondary" onclick="showParticipantsView()" style="margin-bottom: 15px;">â† Back to All Participants</button>
            <div id="designsListContainer">
                <div id="designsMetadata" class="session-metadata"></div>
                <div id="designsList" class="designs-list"></div>
            </div>
        </div>
    </div>

    <!-- Export Data Modal -->
    <div class="export-modal-overlay" id="exportModal">
        <div class="export-modal">
            <div class="export-modal-header">
                <h2>ðŸ“Š Export Data</h2>
                <p>Choose your preferred export format</p>
                <button class="export-close-btn" onclick="closeExportModal()">Ã—</button>
            </div>
            
            <div class="export-options">
                <!-- SPSS Export -->
                <div class="export-card spss-card">
                    <div class="export-icon">ðŸ“ˆ</div>
                    <h3>IBM SPSS Statistics</h3>
                    <p class="export-description">Optimized for statistical analysis including:</p>
                    <ul class="export-features">
                        <li>âœ“ Descriptive Statistics</li>
                        <li>âœ“ Repeated Measures ANOVA</li>
                        <li>âœ“ ICC (Intraclass Correlation)</li>
                        <li>âœ“ Student's t-test</li>
                        <li>âœ“ Effect Size Calculations</li>
                        <li>âœ“ Kolmogorov-Smirnov Test</li>
                    </ul>
                    <div class="export-buttons">
                        <button class="export-btn spss-btn" onclick="downloadSPSSDesignLevel()">
                            ðŸ“‹ Design-Level Data
                            <span class="btn-subtitle">One row per design</span>
                        </button>
                        <button class="export-btn spss-btn" onclick="downloadSPSSParticipantLevel()">
                            ðŸ‘¥ Participant-Level Data
                            <span class="btn-subtitle">One row per participant</span>
                        </button>
                        <button class="export-btn spss-btn" onclick="downloadSPSSSessionLevel()">
                            ðŸ“… Session-Level Data
                            <span class="btn-subtitle">One row per session</span>
                        </button>
                    </div>
                </div>

                <!-- Other Formats -->
                <div class="export-card other-card">
                    <div class="export-icon">ðŸ“</div>
                    <h3>Other Formats</h3>
                    <p class="export-description">Additional export options:</p>
                    <div class="export-buttons">
                        <button class="export-btn json-btn" onclick="downloadAllData()">
                            ðŸ“„ JSON (Complete)
                            <span class="btn-subtitle">Full data with all fields</span>
                        </button>
                        <button class="export-btn csv-btn" onclick="downloadCSV()">
                            ðŸ“Š CSV (Generic)
                            <span class="btn-subtitle">Universal spreadsheet format</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="export-footer">
                <p>ðŸ’¡ <strong>Tip:</strong> For SPSS, use Participant-Level data for group comparisons (t-test, ANOVA) and Session-Level for test-retest reliability (ICC).</p>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Ready Prompt -->
    <div class="modal-overlay" id="readyModal">
        <div class="modal-content">
            <div class="modal-title" data-i18n="ready-title">Are you ready to start the test?</div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-yes" onclick="confirmStart()" data-i18n="ready-start">Yes</button>
                <button class="modal-btn modal-btn-cancel" onclick="cancelStart()" data-i18n="ready-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Violation Prompt -->
    <div class="violation-overlay" id="violationOverlay"></div>
    <div class="violation-prompt" id="violationPrompt">
        <div class="violation-icon">âš ï¸</div>
        <div class="violation-title">Rule Violation</div>
        <div class="violation-message" id="violationMessage"></div>
        <button class="violation-btn" onclick="dismissViolation()">Understood</button>
        <div class="violation-timer" id="violationTimer">Auto-closing in <span id="timerSeconds">30</span>s</div>
    </div>

    <!-- Screen Lock / End Test -->
    <div class="screen-lock" id="screenLock">
        <div class="end-test-card">
            <div class="end-test-icon">â±ï¸</div>
            <div class="end-test-title">Time's Up!</div>
            <div class="end-test-message" id="endTestMessage">
                Great work! You've completed the test.
            </div>
            <button class="end-test-btn" onclick="finalizeTest()">End Test</button>
        </div>
    </div>

    <script>
        // ==================== TRANSLATIONS ====================
        let currentLanguage = 'en';
        const translations = {
            en: {
                // Consent screen
                'consent-title': 'Research Consent',
                'consent-subtitle': 'Five Point Test Assessment',
                'consent-purpose-title': 'Purpose',
                'consent-purpose-text': 'This assessment measures figural fluency and creative design abilities using the Five Point Test methodology.',
                'consent-procedure-title': 'Procedure',
                'consent-procedure-text': 'You will be asked to create as many unique designs as possible by connecting dots within a 5-minute period.',
                'consent-data-title': 'Data Collection',
                'consent-data-text': 'Your designs, timing data, and basic demographic information will be collected for analysis.',
                'consent-rights-title': 'Your Rights',
                'consent-rights-1': 'Participation is voluntary',
                'consent-rights-2': 'You may stop at any time without penalty',
                'consent-rights-3': 'You may request your data be deleted',
                'consent-checkbox-label': 'I have read and understood the information above. I voluntarily agree to participate in this assessment.',
                'consent-decline': 'Decline',
                'consent-agree': 'I Agree',
                // Sign-in screen
                'signin-subtitle': 'Please enter your information to begin',
                'signin-firstname': 'First Name *',
                'signin-lastname': 'Last Name *',
                'signin-age': 'Age *',
                'signin-btn': 'Begin Test',
                'signin-firstname-error': 'Please enter your first name',
                'signin-lastname-error': 'Please enter your last name',
                'signin-age-error': 'Please enter a valid age (6-12 years)',
                // Main test screen
                'test-title': 'AppFLO',
                'test-subtitle': 'Five Point Test - Fluence Graphique',
                'test-objective': 'Create as many different designs as possible by connecting 2 or more dots with straight lines.',
                'test-duration': 'Duration:',
                'test-duration-value': '5 minutes',
                'test-note': 'Note: When you connect all 5 dots, the design auto-saves after 1 second. You can also press "Next Design" anytime.',
                'test-memory': 'Memory: The app saves all designs you create across sessions!',
                'test-rules-title': 'Rules:',
                'test-rule-1': 'Connect 5 dots per design only',
                'test-rule-2': 'Use only straight lines between dots',
                'test-rule-3': 'Each design must be different from all previous ones',
                'test-rule-4': 'Work as quickly as possible within the time limit',
                'test-start-btn': 'Start Test (5 min)',
                'test-clear-btn': 'Clear Current',
                'test-next-btn': 'Next Design â†’',
                'test-total-designs': 'Total Designs',
                'test-current-box': 'Current Box',
                'test-completed-designs': 'Completed Designs:',
                // Progress
                'progress-remaining': 'Time Remaining',
                // Results screen
                'results-title': 'Test Complete!',
                'results-thanks': 'Thank you for your participation!',
                'results-new': 'New Participant',
                // Ready modal
                'ready-title': 'Ready to Start?',
                'ready-text': 'The test will begin immediately. You will have 5 minutes to create as many unique designs as possible.',
                'ready-cancel': 'Cancel',
                'ready-start': 'Start Now',
                // Admin login
                'admin-password': 'Password',
                'admin-login': 'Login',
                'admin-cancel': 'Cancel',
                'admin-error': 'Incorrect password. Please try again.'
            },
            fr: {
                // Consent screen
                'consent-title': 'Consentement de recherche',
                'consent-subtitle': 'Ã‰valuation du test des cinq points',
                'consent-purpose-title': 'Objectif',
                'consent-purpose-text': 'Cette Ã©valuation mesure la fluiditÃ© figurative et les capacitÃ©s de conception crÃ©ative selon la mÃ©thodologie du test des cinq points.',
                'consent-procedure-title': 'ProcÃ©dure',
                'consent-procedure-text': 'Vous devrez crÃ©er autant de dessins uniques que possible en reliant des points dans un dÃ©lai de 5 minutes.',
                'consent-data-title': 'Collecte de donnÃ©es',
                'consent-data-text': 'Vos dessins, donnÃ©es temporelles et informations dÃ©mographiques de base seront collectÃ©s pour analyse.',
                'consent-rights-title': 'Vos droits',
                'consent-rights-1': 'La participation est volontaire',
                'consent-rights-2': 'Vous pouvez arrÃªter Ã  tout moment sans pÃ©nalitÃ©',
                'consent-rights-3': 'Vous pouvez demander la suppression de vos donnÃ©es',
                'consent-checkbox-label': 'J\'ai lu et compris les informations ci-dessus. J\'accepte volontairement de participer Ã  cette Ã©valuation.',
                'consent-decline': 'Refuser',
                'consent-agree': 'J\'accepte',
                // Sign-in screen
                'signin-subtitle': 'Veuillez entrer vos informations pour commencer',
                'signin-firstname': 'PrÃ©nom *',
                'signin-lastname': 'Nom de famille *',
                'signin-age': 'Ã‚ge *',
                'signin-btn': 'Commencer le test',
                'signin-firstname-error': 'Veuillez entrer votre prÃ©nom',
                'signin-lastname-error': 'Veuillez entrer votre nom de famille',
                'signin-age-error': 'Veuillez entrer un Ã¢ge valide (6-12 ans)',
                // Main test screen
                'test-title': 'AppFLO',
                'test-subtitle': 'Test des cinq points - Fluence Graphique',
                'test-objective': 'CrÃ©ez autant de dessins diffÃ©rents que possible en reliant 2 points ou plus avec des lignes droites.',
                'test-duration': 'DurÃ©e:',
                'test-duration-value': '5 minutes',
                'test-note': 'Note: Lorsque vous connectez les 5 points, le dessin s\'enregistre automatiquement aprÃ¨s 1 seconde. Vous pouvez aussi appuyer sur "Dessin suivant" Ã  tout moment.',
                'test-memory': 'MÃ©moire: L\'application sauvegarde tous vos dessins entre les sessions!',
                'test-rules-title': 'RÃ¨gles:',
                'test-rule-1': 'Connectez les 5 points par dessin seulement',
                'test-rule-2': 'Utilisez uniquement des lignes droites entre les points',
                'test-rule-3': 'Chaque dessin doit Ãªtre diffÃ©rent de tous les prÃ©cÃ©dents',
                'test-rule-4': 'Travaillez aussi vite que possible dans le temps imparti',
                'test-start-btn': 'DÃ©marrer (5 min)',
                'test-clear-btn': 'Effacer',
                'test-next-btn': 'Suivant â†’',
                'test-total-designs': 'Total dessins',
                'test-current-box': 'Case actuelle',
                'test-completed-designs': 'Dessins complÃ©tÃ©s:',
                // Progress
                'progress-remaining': 'Temps restant',
                // Results screen
                'results-title': 'Test terminÃ©!',
                'results-thanks': 'Merci de votre participation!',
                'results-new': 'Nouveau participant',
                // Ready modal
                'ready-title': 'PrÃªt Ã  commencer?',
                'ready-text': 'Le test commencera immÃ©diatement. Vous aurez 5 minutes pour crÃ©er autant de dessins uniques que possible.',
                'ready-cancel': 'Annuler',
                'ready-start': 'Commencer',
                // Admin login
                'admin-password': 'Mot de passe',
                'admin-login': 'Connexion',
                'admin-cancel': 'Annuler',
                'admin-error': 'Mot de passe incorrect. Veuillez rÃ©essayer.'
            }
        };

        function setLanguage(lang) {
            currentLanguage = lang;
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === lang);
            });
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });
            localStorage.setItem('appflo-language', lang);
        }

        // ==================== SOUND SYSTEM ====================
        let soundEnabled = true;
        let audioContext = null;

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playSound(type) {
            if (!soundEnabled) return;
            initAudio();
            
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain);
            gain.connect(audioContext.destination);
            
            switch(type) {
                case 'connect':
                    osc.frequency.value = 800;
                    osc.type = 'sine';
                    gain.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    osc.start();
                    osc.stop(audioContext.currentTime + 0.1);
                    break;
                case 'save':
                    osc.frequency.value = 523;
                    osc.type = 'sine';
                    gain.gain.setValueAtTime(0.15, audioContext.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    osc.start();
                    osc.stop(audioContext.currentTime + 0.15);
                    setTimeout(() => {
                        const osc2 = audioContext.createOscillator();
                        const gain2 = audioContext.createGain();
                        osc2.connect(gain2);
                        gain2.connect(audioContext.destination);
                        osc2.frequency.value = 659;
                        osc2.type = 'sine';
                        gain2.gain.setValueAtTime(0.15, audioContext.currentTime);
                        gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                        osc2.start();
                        osc2.stop(audioContext.currentTime + 0.3);
                    }, 150);
                    break;
                case 'warning':
                    osc.frequency.value = 300;
                    osc.type = 'square';
                    gain.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    osc.start();
                    osc.stop(audioContext.currentTime + 0.2);
                    break;
                case 'complete':
                    [523, 659, 784, 1047].forEach((freq, i) => {
                        setTimeout(() => {
                            const o = audioContext.createOscillator();
                            const g = audioContext.createGain();
                            o.connect(g);
                            g.connect(audioContext.destination);
                            o.frequency.value = freq;
                            o.type = 'sine';
                            g.gain.setValueAtTime(0.15, audioContext.currentTime);
                            g.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                            o.start();
                            o.stop(audioContext.currentTime + 0.4);
                        }, i * 150);
                    });
                    break;
            }
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('soundToggle').textContent = soundEnabled ? 'ðŸ”Š' : 'ðŸ”‡';
            localStorage.setItem('appflo-sound', soundEnabled);
        }

        // ==================== CONSENT FUNCTIONS ====================
        function acceptConsent() {
            document.getElementById('consentScreen').style.display = 'none';
            document.getElementById('signinScreen').style.display = 'flex';
        }

        function declineConsent() {
            alert(currentLanguage === 'fr' 
                ? 'Merci de votre intÃ©rÃªt. Vous pouvez fermer cette page.'
                : 'Thank you for your interest. You may close this page.');
        }

        // ==================== RESULTS FUNCTIONS ====================
        function showResults() {
            document.querySelector('.container').style.display = 'none';
            document.getElementById('resultsScreen').style.display = 'flex';
            
            document.getElementById('resultName').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
            
            playSound('complete');
        }

        function newParticipant() {
            document.getElementById('resultsScreen').style.display = 'none';
            document.getElementById('signinScreen').style.display = 'flex';
            
            // Reset state
            currentUser = null;
            completedDesigns = [];
            timer = TEST_DURATION;
            document.getElementById('timer').textContent = '05:00';
            document.getElementById('timer').className = 'timer';
            document.getElementById('totalCount').textContent = '0';
            document.getElementById('currentBox').textContent = '1';
            document.getElementById('designsGrid').innerHTML = '';
            document.getElementById('progressFill').style.width = '100%';
            document.getElementById('progressFill').className = 'progress-fill';
            document.getElementById('progressContainer').style.display = 'none';
            
            // Reset form
            document.getElementById('signinForm').reset();
        }

        function viewAdminFromResults() {
            document.getElementById('resultsScreen').style.display = 'none';
            showAdminDashboard();
        }

        // ==================== ADMIN LOGIN ====================
        const ADMIN_PASSWORD = 'admin';

        function showAdminLogin() {
            document.getElementById('adminLoginModal').classList.add('active');
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminLoginError').classList.remove('show');
            document.getElementById('adminPassword').focus();
        }

        function hideAdminLogin() {
            document.getElementById('adminLoginModal').classList.remove('active');
            document.getElementById('firstName').value = '';
        }

        function attemptAdminLogin() {
            const password = document.getElementById('adminPassword').value;
            
            if (password === ADMIN_PASSWORD) {
                // Successful login
                document.getElementById('adminLoginModal').classList.remove('active');
                
                currentUser = {
                    firstName: 'Admin',
                    lastName: 'Admin',
                    age: null,
                    isAdmin: true,
                    signInTime: Date.now(),
                    signInDate: new Date().toISOString()
                };
                
                sessionId = `Admin_${Date.now()}`;
                
                // Hide sign-in and show admin dashboard
                document.getElementById('signinScreen').style.display = 'none';
                showAdminDashboard();
            } else {
                // Wrong password
                document.getElementById('adminLoginError').classList.add('show');
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminPassword').focus();
            }
        }

        // ==================== PROGRESS BAR ====================
        function updateProgressBar() {
            const percent = (timer / TEST_DURATION) * 100;
            const progressFill = document.getElementById('progressFill');
            const progressPercent = document.getElementById('progressPercent');
            
            progressFill.style.width = percent + '%';
            progressPercent.textContent = Math.round(percent) + '%';
            
            // Color changes
            if (timer <= 30) {
                progressFill.className = 'progress-fill critical';
                document.getElementById('timer').className = 'timer critical';
            } else if (timer <= 60) {
                progressFill.className = 'progress-fill warning';
                document.getElementById('timer').className = 'timer warning';
            } else {
                progressFill.className = 'progress-fill';
                document.getElementById('timer').className = 'timer';
            }
            
            // Warning sounds
            if (timer === 60 || timer === 30) {
                playSound('warning');
            }
        }

        // Configuration - Standard Five Point Test format
        const MAX_BOXES = 40; // Standard 8Ã—5 grid = 40 boxes
        const CANVAS_SIZE = 200; // Size of drawing canvas
        const DOT_RADIUS = 8;
        
        // Fixed 5 minute duration
        let TEST_DURATION = 5 * 60; // 5 minutes in seconds
        
        // Five dots arranged like a die: 4 corners + 1 center
        const DOT_POSITIONS = [
            { x: 0.25, y: 0.25, id: 0 }, // Top-left
            { x: 0.75, y: 0.25, id: 1 }, // Top-right
            { x: 0.5,  y: 0.5,  id: 2 }, // Center
            { x: 0.25, y: 0.75, id: 3 }, // Bottom-left
            { x: 0.75, y: 0.75, id: 4 }  // Bottom-right
        ];
        
        // State
        let canvas, ctx;
        let isDrawing = false;
        let currentPath = [];
        let completedDesigns = [];
        let timer = TEST_DURATION;
        let timerInterval = null;
        let isTestActive = false;
        let isPaused = false;
        let dots = [];
        let allTimeDesigns = []; // Store all designs across sessions
        let currentUser = null; // Store current user info
        let sessionId = null; // Unique ID for current session
        
        // Violation tracking
        let violationsShown = {
            strayLine: false,
            repetition: false,
            disconnectedLines: false,
            incompleteLinesCount: false
        };
        let violationTimer = null;
        let violationCountdown = null;

        // Quebec Kids Database (51 participants)
        const quebecKidsDatabase = [
            { firstName: "Antoine", lastName: "Tremblay", age: 8 },
            { firstName: "Lea", lastName: "Gagnon", age: 7 },
            { firstName: "Gabriel", lastName: "Roy", age: 10 },
            { firstName: "Emma", lastName: "Cote", age: 9 },
            { firstName: "Louis", lastName: "Bouchard", age: 11 },
            { firstName: "Bruno", lastName: "Gauthier", age: 12 },
            { firstName: "Thomas", lastName: "Morin", age: 8 },
            { firstName: "Olivia", lastName: "Lavoie", age: 12 },
            { firstName: "William", lastName: "Fortin", age: 7 },
            { firstName: "Juliette", lastName: "Gagne", age: 9 },
            { firstName: "Alexandre", lastName: "Ouellet", age: 10 },
            { firstName: "Sarah", lastName: "Pelletier", age: 8 },
            { firstName: "Mathis", lastName: "Belanger", age: 11 },
            { firstName: "Krystale", lastName: "Bergeron", age: 8 },
            { firstName: "Felix", lastName: "Paquette", age: 9 },
            { firstName: "Rosalie", lastName: "Girard", age: 7 },
            { firstName: "Raphael", lastName: "Simard", age: 12 },
            { firstName: "Alice", lastName: "Boucher", age: 8 },
            { firstName: "Samuel", lastName: "Lessard", age: 10 },
            { firstName: "Maika", lastName: "Poirier", age: 9 },
            { firstName: "Nathan", lastName: "Levesque", age: 7 },
            { firstName: "Eloise", lastName: "Dubois", age: 11 },
            { firstName: "Noah", lastName: "Fournier", age: 6 },
            { firstName: "Laurence", lastName: "Cloutier", age: 8 },
            { firstName: "Jacob", lastName: "Leblanc", age: 9 },
            { firstName: "Camille", lastName: "Beaulieu", age: 12 },
            { firstName: "Olivier", lastName: "Nadeau", age: 7 },
            { firstName: "Zoe", lastName: "Martel", age: 10 },
            { firstName: "Charles", lastName: "Carrier", age: 8 },
            { firstName: "Amelie", lastName: "Thibault", age: 11 },
            { firstName: "Lucas", lastName: "Leclerc", age: 6 },
            { firstName: "Isabelle", lastName: "Vaillancourt", age: 9 },
            { firstName: "Benjamin", lastName: "Hebert", age: 7 },
            { firstName: "Victoria", lastName: "Martin", age: 12 },
            { firstName: "Adam", lastName: "Dion", age: 8 },
            { firstName: "Sophie", lastName: "Leblanc", age: 10 },
            { firstName: "Etienne", lastName: "Proulx", age: 9 },
            { firstName: "Livia", lastName: "Rousseau", age: 7 },
            { firstName: "Maxime", lastName: "Desrosiers", age: 11 },
            { firstName: "Florence", lastName: "Caron", age: 6 },
            { firstName: "Henri", lastName: "St-Pierre", age: 8 },
            { firstName: "Anais", lastName: "Desjardins", age: 9 },
            { firstName: "Hugo", lastName: "Bedard", age: 12 },
            { firstName: "Charlotte", lastName: "Fontaine", age: 7 },
            { firstName: "Xavier", lastName: "Michaud", age: 10 },
            { firstName: "Leonie", lastName: "Blais", age: 8 },
            { firstName: "Mathieu", lastName: "Laflamme", age: 11 },
            { firstName: "Emilie", lastName: "Beaulieu", age: 6 },
            { firstName: "Edouard", lastName: "Turgeon", age: 9 },
            { firstName: "Gabrielle", lastName: "Lapointe", age: 7 },
            { firstName: "Mathieu", lastName: "Hebert", age: 10 }
        ];

        let selectedFirstName = '';
        let matchingKids = [];

        // Initialize
        window.onload = function() {
            canvas = document.getElementById('mainCanvas');
            ctx = canvas.getContext('2d');
            setupCanvas();
            initializeDesignsGrid();
            loadDesignHistory();
            
            // Load saved preferences
            const savedLang = localStorage.getItem('appflo-language') || 'en';
            const savedSound = localStorage.getItem('appflo-sound');
            if (savedSound !== null) {
                soundEnabled = savedSound === 'true';
            }
            document.getElementById('soundToggle').textContent = soundEnabled ? 'ðŸ”Š' : 'ðŸ”‡';
            
            // Setup language toggle
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', () => setLanguage(btn.dataset.lang));
            });
            
            // Setup sound toggle
            document.getElementById('soundToggle').addEventListener('click', toggleSound);
            
            // Setup consent checkbox
            document.getElementById('consentCheckbox').addEventListener('change', function() {
                document.getElementById('agreeBtn').disabled = !this.checked;
            });
            
            // Show splash screen, then consent after 2.5 seconds
            setTimeout(() => {
                document.getElementById('splashScreen').classList.add('hidden');
                document.getElementById('consentScreen').style.display = 'flex';
                document.getElementById('languageToggle').style.display = 'flex';
                document.getElementById('soundToggle').style.display = 'flex';
                setLanguage(savedLang);
            }, 2500);
            
            // Setup autocomplete
            setupAutocomplete();
        };

        // Setup autocomplete functionality
        function setupAutocomplete() {
            const firstNameInput = document.getElementById('firstName');
            const lastNameInput = document.getElementById('lastName');
            const ageInput = document.getElementById('age');
            const firstNameSuggestions = document.getElementById('firstNameSuggestions');
            const lastNameSuggestions = document.getElementById('lastNameSuggestions');

            // First name autocomplete
            firstNameInput.addEventListener('input', function() {
                const value = this.value.trim();
                
                if (value.length < 1) {
                    firstNameSuggestions.classList.remove('show');
                    return;
                }

                // Find matching first names
                const matches = quebecKidsDatabase.filter(kid => 
                    kid.firstName.toLowerCase().startsWith(value.toLowerCase())
                );

                // Get unique first names
                const uniqueFirstNames = [...new Set(matches.map(k => k.firstName))];

                if (uniqueFirstNames.length > 0) {
                    displaySuggestions(uniqueFirstNames, firstNameSuggestions, (name) => {
                        firstNameInput.value = name;
                        selectedFirstName = name;
                        firstNameSuggestions.classList.remove('show');
                        
                        // Auto-focus last name field
                        lastNameInput.focus();
                    });
                } else {
                    firstNameSuggestions.classList.remove('show');
                }
            });

            // Last name autocomplete - triggered when focused
            lastNameInput.addEventListener('focus', function() {
                updateLastNameSuggestions();
            });

            lastNameInput.addEventListener('input', function() {
                updateLastNameSuggestions();
            });

            function updateLastNameSuggestions() {
                const firstNameValue = firstNameInput.value.trim();
                const lastNameValue = lastNameInput.value.trim();

                if (!firstNameValue) {
                    lastNameSuggestions.classList.remove('show');
                    return;
                }

                // Find kids matching the first name
                matchingKids = quebecKidsDatabase.filter(kid => 
                    kid.firstName.toLowerCase() === firstNameValue.toLowerCase()
                );

                if (matchingKids.length === 0) {
                    lastNameSuggestions.classList.remove('show');
                    return;
                }

                // Filter by last name input if provided
                let filteredKids = matchingKids;
                if (lastNameValue) {
                    filteredKids = matchingKids.filter(kid =>
                        kid.lastName.toLowerCase().startsWith(lastNameValue.toLowerCase())
                    );
                }

                if (filteredKids.length > 0) {
                    const lastNames = filteredKids.map(k => k.lastName);
                    // Remove duplicates
                    const uniqueLastNames = [...new Set(lastNames)];
                    
                    displaySuggestions(uniqueLastNames, lastNameSuggestions, (lastName) => {
                        lastNameInput.value = lastName;
                        lastNameSuggestions.classList.remove('show');
                        
                        // Auto-focus age field
                        ageInput.focus();
                    });
                } else {
                    lastNameSuggestions.classList.remove('show');
                }
            }

            // Close suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.autocomplete-container')) {
                    firstNameSuggestions.classList.remove('show');
                    lastNameSuggestions.classList.remove('show');
                }
            });
        }

        function displaySuggestions(items, container, onSelect) {
            container.innerHTML = '';
            
            if (items.length === 0) {
                container.innerHTML = '<div class="no-results">No matches found</div>';
                container.classList.add('show');
                return;
            }

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'autocomplete-item';
                div.textContent = item;
                div.addEventListener('click', () => onSelect(item));
                container.appendChild(div);
            });

            container.classList.add('show');
        }

        // Handle sign-in form submission
        function handleSignIn(event) {
            event.preventDefault();
            
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const age = parseInt(document.getElementById('age').value);
            
            // Check for admin login trigger
            if (firstName.toLowerCase() === 'admin') {
                showAdminLogin();
                return;
            }
            
            // Normal user validation
            let isValid = true;
            
            if (!firstName) {
                document.getElementById('firstNameError').classList.add('show');
                document.getElementById('firstName').classList.add('error');
                isValid = false;
            } else {
                document.getElementById('firstNameError').classList.remove('show');
                document.getElementById('firstName').classList.remove('error');
            }
            
            if (!lastName) {
                document.getElementById('lastNameError').classList.add('show');
                document.getElementById('lastName').classList.add('error');
                isValid = false;
            } else {
                document.getElementById('lastNameError').classList.remove('show');
                document.getElementById('lastName').classList.remove('error');
            }
            
            if (!age || age < 6 || age > 12) {
                document.getElementById('ageError').classList.add('show');
                document.getElementById('age').classList.add('error');
                isValid = false;
            } else {
                document.getElementById('ageError').classList.remove('show');
                document.getElementById('age').classList.remove('error');
            }
            
            if (!isValid) return;
            
            // Save user info (only in memory, not localStorage)
            currentUser = {
                firstName: firstName,
                lastName: lastName,
                age: age,
                isAdmin: false,
                signInTime: Date.now(),
                signInDate: new Date().toISOString()
            };
            
            // Create unique session ID
            sessionId = `${firstName}_${lastName}_${Date.now()}`;
            
            // Show main app
            showMainApp();
        }

        function showMainApp() {
            // Hide sign-in screen
            document.getElementById('signinScreen').classList.add('hidden');
            document.getElementById('signinScreen').style.display = 'none';
            
            // Show main container
            document.querySelector('.container').style.display = 'block';
            
            // Display user info
            const displayName = `${currentUser.firstName} ${currentUser.lastName}`;
            document.getElementById('displayName').textContent = displayName;
            document.getElementById('displayAge').textContent = currentUser.age;
            document.getElementById('userInfoDisplay').style.display = 'block';
        }

        function showAdminDashboard() {
            // Hide sign-in screen
            document.getElementById('signinScreen').classList.add('hidden');
            document.getElementById('signinScreen').style.display = 'none';
            
            // Show admin dashboard
            document.getElementById('adminDashboard').classList.add('active');
            
            // Force reload data from localStorage to ensure we have latest
            loadDesignHistory();
            console.log('Admin dashboard - reloaded designs from localStorage:', allTimeDesigns.length);
            
            // Load admin data
            loadAdminData();
        }

        function loadAdminData() {
            console.log('Loading admin data. Total designs:', allTimeDesigns.length);
            
            if (allTimeDesigns.length > 0) {
                console.log('First design user:', allTimeDesigns[0].user);
                console.log('Last design user:', allTimeDesigns[allTimeDesigns.length - 1].user);
            }
            
            // Calculate statistics
            const totalDesigns = allTimeDesigns.length;
            
            // Group by participant
            const participantsMap = {};
            allTimeDesigns.forEach(design => {
                if (!design.user) {
                    console.warn('Design missing user data:', design);
                    return;
                }
                const participantKey = `${design.user.firstName}_${design.user.lastName}`;
                if (!participantsMap[participantKey]) {
                    participantsMap[participantKey] = {
                        firstName: design.user.firstName,
                        lastName: design.user.lastName,
                        age: design.user.age,
                        sessions: {}
                    };
                }
                if (!participantsMap[participantKey].sessions[design.sessionId]) {
                    participantsMap[participantKey].sessions[design.sessionId] = [];
                }
                participantsMap[participantKey].sessions[design.sessionId].push(design);
            });
            
            console.log('Participants map:', participantsMap);
            
            const totalParticipants = Object.keys(participantsMap).length;
            const totalSessions = Object.values(participantsMap).reduce((sum, p) => 
                sum + Object.keys(p.sessions).length, 0);
            
            console.log('Total participants:', totalParticipants, 'Total sessions:', totalSessions);
            
            // Update stats
            document.getElementById('adminTotalDesigns').textContent = totalDesigns;
            document.getElementById('adminTotalParticipants').textContent = totalParticipants;
            document.getElementById('adminTotalSessions').textContent = totalSessions;
            
            // Show participants view
            showParticipantsView();
        }

        let currentParticipant = null;
        let currentSessionId = null;

        function showParticipantsView() {
            // Hide other views
            document.getElementById('designsView').style.display = 'none';
            document.getElementById('participantsView').style.display = 'block';
            
            // Reset navigation
            currentParticipant = null;
            currentSessionId = null;
            document.getElementById('breadcrumbPath').textContent = '';
            
            // Debug: Check if allTimeDesigns has data
            console.log('showParticipantsView - Total designs:', allTimeDesigns.length);
            
            // Group designs by participant
            const participantsMap = {};
            allTimeDesigns.forEach((design, index) => {
                if (!design.user) {
                    console.log('Design #' + index + ' missing user:', design);
                    return;
                }
                const participantKey = `${design.user.firstName}_${design.user.lastName}`;
                if (!participantsMap[participantKey]) {
                    participantsMap[participantKey] = {
                        firstName: design.user.firstName,
                        lastName: design.user.lastName,
                        age: design.user.age,
                        designs: []
                    };
                    console.log('Added participant:', participantKey);
                }
                participantsMap[participantKey].designs.push(design);
            });
            
            console.log('Total unique participants:', Object.keys(participantsMap).length);
            console.log('Participant keys:', Object.keys(participantsMap));
            
            // Display participant folders
            const participantsList = document.getElementById('participantsList');
            participantsList.innerHTML = '';
            
            if (Object.keys(participantsMap).length === 0) {
                participantsList.innerHTML = '<p style="color: #666; padding: 20px;">No participants found. Start testing to see data here.</p>';
                return;
            }
            
            Object.keys(participantsMap).sort().forEach(participantKey => {
                const participant = participantsMap[participantKey];
                const totalDesigns = participant.designs.length;
                const sessionsSet = new Set(participant.designs.map(d => d.sessionId));
                const sessionCount = sessionsSet.size;
                
                console.log('Creating folder for:', participantKey, 'with', totalDesigns, 'designs');
                
                const folderDiv = document.createElement('div');
                folderDiv.className = 'folder-item';
                folderDiv.onclick = () => showDesignsView(participantKey, participant);
                folderDiv.innerHTML = `
                    <div class="folder-icon">ðŸ‘¤</div>
                    <div class="folder-name">${participant.firstName} ${participant.lastName}</div>
                    <div class="folder-info">Age: ${participant.age || 'N/A'}</div>
                    <div class="folder-info">${sessionCount} session(s)</div>
                    <div class="folder-info">${totalDesigns} design(s)</div>
                `;
                participantsList.appendChild(folderDiv);
            });
            
            console.log('Finished creating', Object.keys(participantsMap).length, 'folder items');
        }

        function showDesignsView(participantKey, participant) {
            currentParticipant = { key: participantKey, data: participant };
            
            // Update breadcrumb
            document.getElementById('breadcrumbPath').textContent = 
                ` > ${participant.firstName} ${participant.lastName}`;
            
            // Hide other views
            document.getElementById('participantsView').style.display = 'none';
            document.getElementById('designsView').style.display = 'block';
            
            // Update title
            document.getElementById('designsTitle').textContent = 
                `All Designs for ${participant.firstName} ${participant.lastName}`;
            
            const designs = participant.designs;
            
            // Calculate statistics
            const totalDesigns = designs.length;
            const designsWithViolations = designs.filter(d => d.hasViolation).length;
            const sessionsSet = new Set(designs.map(d => d.sessionId));
            const sessionCount = sessionsSet.size;
            
            // Group designs by session for display
            const sessionGroups = {};
            designs.forEach(design => {
                if (!sessionGroups[design.sessionId]) {
                    sessionGroups[design.sessionId] = [];
                }
                sessionGroups[design.sessionId].push(design);
            });
            
            // Display metadata with statistics
            const stats = calculateParticipantStats(designs);
            const metadata = document.getElementById('designsMetadata');
            metadata.innerHTML = `
                <h4>Participant Information</h4>
                <p><strong>Name:</strong> ${participant.firstName} ${participant.lastName}</p>
                <p><strong>Age:</strong> ${participant.age}</p>
                <p><strong>Total Sessions:</strong> ${sessionCount}</p>
                <p><strong>Total Designs:</strong> ${totalDesigns}</p>
                <p><strong>Unique Designs:</strong> ${stats.uniqueDesigns}</p>
                <p><strong>Repeated Designs:</strong> ${totalDesigns - stats.uniqueDesigns}</p>
                <p><strong>Complete Designs (5 dots):</strong> ${stats.completeDesigns}</p>
                <p><strong>Incomplete Designs:</strong> ${stats.incompleteDesigns}</p>
                <hr style="margin: 10px 0; border: none; border-top: 1px solid #ddd;">
                <p style="color: #F59E0B; font-weight: bold;"><strong>â­ Original Designs:</strong> ${stats.originalDesigns}</p>
                <p style="color: #2196F3; font-weight: bold;"><strong>ðŸ”„ Spatial Strategy Count:</strong> ${stats.spatialStrategyCount}</p>
                <ul style="margin: 5px 0 0 20px; font-size: 14px; color: #2196F3;">
                    <li>Rotations: ${stats.rotationCount}</li>
                    <li>Mirrors: ${stats.mirrorCount}</li>
                </ul>
                <p style="color: #4CAF50; font-weight: bold;"><strong>âž• Numerical Strategy Count:</strong> ${stats.numericalStrategyCount}</p>
                <ul style="margin: 5px 0 0 20px; font-size: 14px; color: #4CAF50;">
                    <li>Line Additions: ${stats.additionCount}</li>
                    <li>Line Removals: ${stats.removalCount}</li>
                </ul>
                <hr style="margin: 10px 0; border: none; border-top: 1px solid #ddd;">
                <p><strong>Total Violations:</strong> ${designsWithViolations}</p>
                <p><strong>Violations by Type:</strong></p>
                <ul style="margin: 5px 0 0 20px; font-size: 14px;">
                    <li>Incomplete Lines: ${stats.violationsByType.incompleteLinesCount}</li>
                    <li>Repetitions: ${stats.violationsByType.repetition}</li>
                    <li>Disconnected Lines: ${stats.violationsByType.disconnectedLines}</li>
                    <li>Stray Lines: ${stats.violationsByType.strayLine}</li>
                </ul>
                <p><strong>Average Path Length:</strong> ${stats.averagePathLength} pixels</p>
                <p><strong>Average Dots Connected:</strong> ${stats.averageDotsConnected}/5</p>
            `;
            
            // Display all designs grouped by session
            const designsList = document.getElementById('designsList');
            designsList.innerHTML = '';
            
            // Sort sessions by date
            const sortedSessionIds = Object.keys(sessionGroups).sort((a, b) => {
                const designA = sessionGroups[a][0];
                const designB = sessionGroups[b][0];
                return (designA.signInTime || designA.timestamp) - (designB.signInTime || designB.timestamp);
            });
            
            sortedSessionIds.forEach(sessionId => {
                const sessionDesigns = sessionGroups[sessionId];
                const firstDesign = sessionDesigns[0];
                const sessionDate = new Date(firstDesign.signInDate || firstDesign.timestamp);
                
                // Add session header
                const sessionHeader = document.createElement('div');
                sessionHeader.style.cssText = 'grid-column: 1 / -1; background: #f0f0f0; padding: 10px; border-radius: 6px; margin-top: 10px; font-weight: 600;';
                sessionHeader.innerHTML = `ðŸ“… Session: ${sessionDate.toLocaleString()} (${sessionDesigns.length} designs)`;
                designsList.appendChild(sessionHeader);
                
                // Add all designs from this session
                sessionDesigns.forEach((design, index) => {
                    const designCard = document.createElement('div');
                    
                    // Check if this is the first occurrence of this pattern in the session
                    const isFirstOriginal = design.isOriginal !== false && 
                        !design.isSpatialStrategy && 
                        !design.isNumericalStrategy &&
                        !design.hasViolation;
                    
                    // Determine card class based on violation and strategies
                    let cardClass = 'design-card';
                    if (design.isSpatialStrategy) {
                        cardClass += ' spatial-strategy';
                    } else if (design.isNumericalStrategy) {
                        cardClass += ' numerical-strategy';
                    } else if (design.hasViolation) {
                        cardClass += ' violation';
                    } else if (isFirstOriginal) {
                        cardClass += ' first-original';
                    }
                    designCard.className = cardClass;
                    
                    const designTime = new Date(design.timestampISO || design.timestamp);
                    const violationsText = design.violations && design.violations.length > 0 
                        ? design.violations.join(', ') : 'None';
                    
                    // Recreate the design canvas
                    const canvas = document.createElement('canvas');
                    canvas.width = 200;
                    canvas.height = 200;
                    const ctx = canvas.getContext('2d');
                    
                    // Draw border
                    ctx.strokeStyle = '#ccc';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(0, 0, 200, 200);
                    
                    // Draw dots
                    const dotPositions = [
                        { x: 0.25, y: 0.25 },
                        { x: 0.75, y: 0.25 },
                        { x: 0.5, y: 0.5 },
                        { x: 0.25, y: 0.75 },
                        { x: 0.75, y: 0.75 }
                    ];
                    
                    dotPositions.forEach(pos => {
                        ctx.fillStyle = '#2196F3';
                        ctx.beginPath();
                        ctx.arc(pos.x * 200, pos.y * 200, 6, 0, Math.PI * 2);
                        ctx.fill();
                    });
                    
                    // Draw path
                    if (design.path && design.path.length > 1) {
                        ctx.strokeStyle = design.hasViolation ? '#f44336' : '#4CAF50';
                        ctx.lineWidth = 3;
                        ctx.lineCap = 'round';
                        ctx.lineJoin = 'round';
                        ctx.beginPath();
                        ctx.moveTo(design.path[0].x, design.path[0].y);
                        for (let i = 1; i < design.path.length; i++) {
                            ctx.lineTo(design.path[i].x, design.path[i].y);
                        }
                        ctx.stroke();
                    }
                    
                    designCard.innerHTML = `
                        <div class="design-header">
                            <span class="design-number">Design #${index + 1}</span>
                            ${design.hasViolation ? '<span class="violation-badge">VIOLATION</span>' : ''}
                            ${design.isOriginal === false ? '<span class="violation-badge" style="background: #ff9800;">REPEAT</span>' : ''}
                            ${design.isSpatialStrategy ? '<span class="spatial-badge">ðŸ”„ ' + (design.spatialStrategyType === 'rotation' ? 'ROTATION' : 'MIRROR') + '</span>' : ''}
                            ${design.isNumericalStrategy ? '<span class="numerical-badge">âž• ' + (design.numericalStrategyType === 'addition' ? 'ADDITION' : 'REMOVAL') + '</span>' : ''}
                            ${isFirstOriginal ? '<span class="original-badge">â­ ORIGINAL</span>' : ''}
                        </div>
                        <div class="design-canvas-container"></div>
                        <div class="design-info">
                            <p><strong>Time:</strong> ${designTime.toLocaleTimeString()}</p>
                            <p><strong>Dots Connected:</strong> ${design.dotsConnected || design.path.length}/5</p>
                            <p><strong>Trajectories:</strong> ${design.trajectories || (design.path ? design.path.length - 1 : 0)}</p>
                            <p><strong>Path Length:</strong> ${design.pathLength || calculatePathLength(design.path)} px</p>
                            <p><strong>Original Design:</strong> ${design.isOriginal !== false ? 'Yes' : 'No'}</p>
                            ${design.repetitionCount > 0 ? `<p><strong>Times Repeated:</strong> ${design.repetitionCount}</p>` : ''}
                            ${design.isSpatialStrategy ? `<p style="color: #2196F3;"><strong>ðŸ”„ Spatial Strategy:</strong> ${design.spatialTransformation}</p>` : ''}
                            ${design.isNumericalStrategy ? `<p style="color: #4CAF50;"><strong>âž• Numerical Strategy:</strong> ${design.numericalTransformation}</p>` : ''}
                            ${isFirstOriginal ? `<p style="color: #F59E0B;"><strong>â­ First Original Design</strong></p>` : ''}
                            <p><strong>Violations:</strong> ${violationsText}</p>
                        </div>
                    `;
                    
                    designCard.querySelector('.design-canvas-container').appendChild(canvas);
                    designsList.appendChild(designCard);
                });
            });
        }

        function downloadAllData() {
            const dataStr = JSON.stringify(allTimeDesigns, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `appflo_data_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function downloadCSV() {
            // Create CSV header with all metrics
            let csv = 'Index,Session ID,First Name,Last Name,Age,Sign-in Date,Design Time,Has Violation,Violations,';
            csv += 'Total Strokes,Trajectories,Path Length,Dots Connected,Is Complete,Is Original,Repetition Count,Design Pattern,Path\n';
            
            // Add data rows
            allTimeDesigns.forEach((design, index) => {
                const violations = design.violations && design.violations.length > 0 
                    ? `"${design.violations.join('; ')}"` 
                    : 'None';
                
                const path = design.path ? `"${JSON.stringify(design.path)}"` : '""';
                
                csv += `${index + 1},`;
                csv += `${design.sessionId || 'N/A'},`;
                csv += `${design.user ? design.user.firstName : 'N/A'},`;
                csv += `${design.user ? design.user.lastName : 'N/A'},`;
                csv += `${design.user ? design.user.age : 'N/A'},`;
                csv += `${design.signInDate || 'N/A'},`;
                csv += `${design.timestampISO || new Date(design.timestamp).toISOString()},`;
                csv += `${design.hasViolation || false},`;
                csv += `${violations},`;
                csv += `${design.totalStrokes || 1},`;
                csv += `${design.trajectories || (design.path ? design.path.length - 1 : 0)},`;
                csv += `${design.pathLength || calculatePathLength(design.path || [])},`;
                csv += `${design.dotsConnected || (design.path ? design.path.length : 0)},`;
                csv += `${design.isComplete || false},`;
                csv += `${design.isOriginal !== false},`;
                csv += `${design.repetitionCount || 0},`;
                csv += `${design.designPattern || pathToString(design.path || [])},`;
                csv += `${path}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `appflo_data_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);
            closeExportModal();
        }

        // Export Modal Functions
        function showExportModal() {
            document.getElementById('exportModal').classList.add('active');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('active');
        }

        // SPSS Export Functions
        // Design-Level: One row per design (for detailed analysis)
        function downloadSPSSDesignLevel() {
            // SPSS-friendly variable names (max 64 chars, no spaces, starts with letter)
            let csv = 'ID,ParticipantID,SessionID,SessionNum,FirstName,LastName,Age,';
            csv += 'TestDate,TestTime,DesignNum,DesignTime,';
            csv += 'TotalStrokes,Trajectories,PathLength,DotsConnected,';
            csv += 'IsComplete,IsOriginal,IsRepetition,RepetitionCount,';
            csv += 'IsSpatialStrategy,SpatialType,IsNumericalStrategy,NumericalType,';
            csv += 'HasViolation,ViolationIncomplete,ViolationRepetition,ViolationDisconnected,ViolationStray,';
            csv += 'DesignPattern\n';
            
            let designId = 1;
            
            allTimeDesigns.forEach((design, index) => {
                const participantId = design.user ? `${design.user.firstName}_${design.user.lastName}` : 'Unknown';
                const sessionDate = design.signInDate ? new Date(design.signInDate) : new Date(design.timestamp);
                const designTime = design.timestampISO ? new Date(design.timestampISO) : new Date(design.timestamp);
                
                // Find session number for this participant
                const participantDesigns = allTimeDesigns.filter(d => 
                    d.user && d.user.firstName === design.user?.firstName && d.user.lastName === design.user?.lastName
                );
                const sessions = [...new Set(participantDesigns.map(d => d.sessionId))].sort();
                const sessionNum = sessions.indexOf(design.sessionId) + 1;
                
                // Find design number within session
                const sessionDesigns = allTimeDesigns.filter(d => d.sessionId === design.sessionId);
                const designNum = sessionDesigns.indexOf(design) + 1;
                
                // Violation flags
                const violations = design.violations || [];
                const violIncomplete = violations.includes('incompleteLinesCount') ? 1 : 0;
                const violRepetition = violations.includes('repetition') ? 1 : 0;
                const violDisconnected = violations.includes('disconnectedLines') ? 1 : 0;
                const violStray = violations.includes('strayLine') ? 1 : 0;
                
                csv += `${designId},`;
                csv += `"${participantId}",`;
                csv += `"${design.sessionId || ''}",`;
                csv += `${sessionNum},`;
                csv += `"${design.user?.firstName || ''}",`;
                csv += `"${design.user?.lastName || ''}",`;
                csv += `${design.user?.age || ''},`;
                csv += `${sessionDate.toISOString().split('T')[0]},`;
                csv += `${sessionDate.toTimeString().split(' ')[0]},`;
                csv += `${designNum},`;
                csv += `${designTime.toTimeString().split(' ')[0]},`;
                csv += `${design.totalStrokes || 1},`;
                csv += `${design.trajectories || 0},`;
                csv += `${design.pathLength || 0},`;
                csv += `${design.dotsConnected || 0},`;
                csv += `${design.isComplete ? 1 : 0},`;
                csv += `${design.isOriginal !== false ? 1 : 0},`;
                csv += `${design.isOriginal === false ? 1 : 0},`;
                csv += `${design.repetitionCount || 0},`;
                csv += `${design.isSpatialStrategy ? 1 : 0},`;
                csv += `"${design.spatialStrategyType || ''}",`;
                csv += `${design.isNumericalStrategy ? 1 : 0},`;
                csv += `"${design.numericalStrategyType || ''}",`;
                csv += `${design.hasViolation ? 1 : 0},`;
                csv += `${violIncomplete},`;
                csv += `${violRepetition},`;
                csv += `${violDisconnected},`;
                csv += `${violStray},`;
                csv += `"${design.designPattern || ''}"\n`;
                
                designId++;
            });
            
            downloadFile(csv, `AppFLO_SPSS_DesignLevel_${getDateStamp()}.csv`);
            closeExportModal();
        }

        // Participant-Level: One row per participant (for group comparisons)
        function downloadSPSSParticipantLevel() {
            // Group by participant
            const participants = {};
            allTimeDesigns.forEach(design => {
                if (!design.user) return;
                const key = `${design.user.firstName}_${design.user.lastName}`;
                if (!participants[key]) {
                    participants[key] = {
                        firstName: design.user.firstName,
                        lastName: design.user.lastName,
                        age: design.user.age,
                        designs: [],
                        sessions: new Set()
                    };
                }
                participants[key].designs.push(design);
                participants[key].sessions.add(design.sessionId);
            });
            
            // CSV Header
            let csv = 'ParticipantID,FirstName,LastName,Age,';
            csv += 'TotalSessions,TotalDesigns,UniqueDesigns,RepeatedDesigns,';
            csv += 'CompleteDesigns,IncompleteDesigns,OriginalDesigns,';
            csv += 'SpatialStrategyCount,RotationCount,MirrorCount,';
            csv += 'NumericalStrategyCount,AdditionCount,RemovalCount,';
            csv += 'TotalViolations,ViolationsIncomplete,ViolationsRepetition,ViolationsDisconnected,ViolationsStray,';
            csv += 'MeanPathLength,SDPathLength,MeanDotsConnected,SDDotsConnected,';
            csv += 'MeanTrajectories,SDTrajectories,';
            csv += 'DesignsPerMinute\n';
            
            Object.keys(participants).forEach(key => {
                const p = participants[key];
                const stats = calculateParticipantStats(p.designs);
                
                // Calculate standard deviations
                const pathLengths = p.designs.map(d => d.pathLength || 0);
                const dotsConnected = p.designs.map(d => d.dotsConnected || 0);
                const trajectories = p.designs.map(d => d.trajectories || 0);
                
                const sdPathLength = calculateSD(pathLengths);
                const sdDotsConnected = calculateSD(dotsConnected);
                const sdTrajectories = calculateSD(trajectories);
                
                // Designs per minute (assuming 5 min test)
                const designsPerMinute = (p.designs.length / (5 * p.sessions.size)).toFixed(2);
                
                csv += `"${key}",`;
                csv += `"${p.firstName}",`;
                csv += `"${p.lastName}",`;
                csv += `${p.age},`;
                csv += `${p.sessions.size},`;
                csv += `${stats.totalDesigns},`;
                csv += `${stats.uniqueDesigns},`;
                csv += `${stats.repeatedDesigns},`;
                csv += `${stats.completeDesigns},`;
                csv += `${stats.incompleteDesigns},`;
                csv += `${stats.originalDesigns},`;
                csv += `${stats.spatialStrategyCount},`;
                csv += `${stats.rotationCount},`;
                csv += `${stats.mirrorCount},`;
                csv += `${stats.numericalStrategyCount},`;
                csv += `${stats.additionCount},`;
                csv += `${stats.removalCount},`;
                csv += `${stats.totalViolations},`;
                csv += `${stats.violationsByType.incompleteLinesCount},`;
                csv += `${stats.violationsByType.repetition},`;
                csv += `${stats.violationsByType.disconnectedLines},`;
                csv += `${stats.violationsByType.strayLine},`;
                csv += `${stats.averagePathLength},`;
                csv += `${sdPathLength},`;
                csv += `${stats.averageDotsConnected},`;
                csv += `${sdDotsConnected},`;
                csv += `${(trajectories.reduce((a,b) => a+b, 0) / trajectories.length || 0).toFixed(2)},`;
                csv += `${sdTrajectories},`;
                csv += `${designsPerMinute}\n`;
            });
            
            downloadFile(csv, `AppFLO_SPSS_ParticipantLevel_${getDateStamp()}.csv`);
            closeExportModal();
        }

        // Session-Level: One row per session (for test-retest reliability, ICC)
        function downloadSPSSSessionLevel() {
            // Group by session
            const sessions = {};
            allTimeDesigns.forEach(design => {
                if (!design.sessionId) return;
                if (!sessions[design.sessionId]) {
                    sessions[design.sessionId] = {
                        sessionId: design.sessionId,
                        user: design.user,
                        signInDate: design.signInDate,
                        signInTime: design.signInTime,
                        designs: []
                    };
                }
                sessions[design.sessionId].designs.push(design);
            });
            
            // Sort sessions by participant and date
            const sortedSessions = Object.values(sessions).sort((a, b) => {
                const nameA = `${a.user?.firstName}_${a.user?.lastName}`;
                const nameB = `${b.user?.firstName}_${b.user?.lastName}`;
                if (nameA !== nameB) return nameA.localeCompare(nameB);
                return (a.signInTime || 0) - (b.signInTime || 0);
            });
            
            // Track session number per participant
            const participantSessionCounts = {};
            
            // CSV Header
            let csv = 'SessionID,ParticipantID,FirstName,LastName,Age,';
            csv += 'SessionNum,TestDate,TestTime,';
            csv += 'TotalDesigns,UniqueDesigns,RepeatedDesigns,';
            csv += 'CompleteDesigns,IncompleteDesigns,OriginalDesigns,';
            csv += 'SpatialStrategyCount,RotationCount,MirrorCount,';
            csv += 'NumericalStrategyCount,AdditionCount,RemovalCount,';
            csv += 'TotalViolations,ViolationsIncomplete,ViolationsRepetition,ViolationsDisconnected,ViolationsStray,';
            csv += 'MeanPathLength,SDPathLength,MeanDotsConnected,SDDotsConnected,';
            csv += 'MeanTrajectories,SDTrajectories,';
            csv += 'DesignsPerMinute,TestDuration\n';
            
            sortedSessions.forEach(session => {
                const participantKey = `${session.user?.firstName}_${session.user?.lastName}`;
                participantSessionCounts[participantKey] = (participantSessionCounts[participantKey] || 0) + 1;
                const sessionNum = participantSessionCounts[participantKey];
                
                const stats = calculateParticipantStats(session.designs);
                const sessionDate = session.signInDate ? new Date(session.signInDate) : new Date();
                
                // Calculate SDs
                const pathLengths = session.designs.map(d => d.pathLength || 0);
                const dotsConnected = session.designs.map(d => d.dotsConnected || 0);
                const trajectories = session.designs.map(d => d.trajectories || 0);
                
                const sdPathLength = calculateSD(pathLengths);
                const sdDotsConnected = calculateSD(dotsConnected);
                const sdTrajectories = calculateSD(trajectories);
                
                // Calculate test duration and designs per minute
                const timestamps = session.designs.map(d => d.timestamp || 0).filter(t => t > 0);
                const testDuration = timestamps.length > 1 
                    ? ((Math.max(...timestamps) - Math.min(...timestamps)) / 60000).toFixed(2) 
                    : '5.00';
                const designsPerMinute = (session.designs.length / parseFloat(testDuration || 5)).toFixed(2);
                
                csv += `"${session.sessionId}",`;
                csv += `"${participantKey}",`;
                csv += `"${session.user?.firstName || ''}",`;
                csv += `"${session.user?.lastName || ''}",`;
                csv += `${session.user?.age || ''},`;
                csv += `${sessionNum},`;
                csv += `${sessionDate.toISOString().split('T')[0]},`;
                csv += `${sessionDate.toTimeString().split(' ')[0]},`;
                csv += `${stats.totalDesigns},`;
                csv += `${stats.uniqueDesigns},`;
                csv += `${stats.repeatedDesigns},`;
                csv += `${stats.completeDesigns},`;
                csv += `${stats.incompleteDesigns},`;
                csv += `${stats.originalDesigns},`;
                csv += `${stats.spatialStrategyCount},`;
                csv += `${stats.rotationCount},`;
                csv += `${stats.mirrorCount},`;
                csv += `${stats.numericalStrategyCount},`;
                csv += `${stats.additionCount},`;
                csv += `${stats.removalCount},`;
                csv += `${stats.totalViolations},`;
                csv += `${stats.violationsByType.incompleteLinesCount},`;
                csv += `${stats.violationsByType.repetition},`;
                csv += `${stats.violationsByType.disconnectedLines},`;
                csv += `${stats.violationsByType.strayLine},`;
                csv += `${stats.averagePathLength},`;
                csv += `${sdPathLength},`;
                csv += `${stats.averageDotsConnected},`;
                csv += `${sdDotsConnected},`;
                csv += `${(trajectories.reduce((a,b) => a+b, 0) / trajectories.length || 0).toFixed(2)},`;
                csv += `${sdTrajectories},`;
                csv += `${designsPerMinute},`;
                csv += `${testDuration}\n`;
            });
            
            downloadFile(csv, `AppFLO_SPSS_SessionLevel_${getDateStamp()}.csv`);
            closeExportModal();
        }

        // Helper: Calculate Standard Deviation
        function calculateSD(arr) {
            if (arr.length === 0) return 0;
            const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
            const squareDiffs = arr.map(value => Math.pow(value - mean, 2));
            const avgSquareDiff = squareDiffs.reduce((a, b) => a + b, 0) / arr.length;
            return Math.sqrt(avgSquareDiff).toFixed(2);
        }

        // Helper: Get date stamp for filenames
        function getDateStamp() {
            return new Date().toISOString().split('T')[0];
        }

        // Helper: Download file
        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        function clearAllData() {
            if (confirm('Are you sure you want to delete ALL stored design data? This cannot be undone!')) {
                if (confirm('Final confirmation: Delete all data permanently?')) {
                    allTimeDesigns = [];
                    saveDesignHistory();
                    loadAdminData();
                    alert('All data has been cleared.');
                }
            }
        }

        function logoutAdmin() {
            // Hide admin dashboard
            document.getElementById('adminDashboard').classList.remove('active');
            
            // Reset and show sign-in screen
            document.getElementById('firstName').value = '';
            document.getElementById('lastName').value = '';
            document.getElementById('age').value = '';
            currentUser = null;
            sessionId = null;
            
            document.getElementById('signinScreen').classList.remove('hidden');
            document.getElementById('signinScreen').style.display = 'flex';
        }

        // Generate realistic demo data
        function generateDemoData() {
            try {
                // Always clear existing data first
                const shouldContinue = allTimeDesigns.length > 0 
                    ? confirm('This will replace existing data. Continue?')
                    : true;
                    
                if (!shouldContinue) return;
                
                // Clear everything - use correct localStorage key
                allTimeDesigns = [];
                completedDesigns = [];
                localStorage.removeItem('fivePointTestHistory');
                
                console.log('Cleared all data, generating demo data...');
            
            // Sample participants with strategy preferences
            // strategyPreference: 'spatial', 'numerical', 'both', 'none'
            const participants = [
                { firstName: "Antoine", lastName: "Tremblay", age: 8, sessions: 2, strategyPreference: 'spatial' },
                { firstName: "Lea", lastName: "Gagnon", age: 7, sessions: 1, strategyPreference: 'numerical' },
                { firstName: "Gabriel", lastName: "Roy", age: 10, sessions: 2, strategyPreference: 'both' },
                { firstName: "Emma", lastName: "Cote", age: 9, sessions: 1, strategyPreference: 'none' },
                { firstName: "Mathieu", lastName: "Hebert", age: 10, sessions: 2, strategyPreference: 'numerical' }
            ];
            
            // Dot positions for creating paths
            const dotPositions = [
                { x: 50, y: 50, id: 0 },    // Top-left
                { x: 150, y: 50, id: 1 },   // Top-right
                { x: 100, y: 100, id: 2 },  // Center
                { x: 50, y: 150, id: 3 },   // Bottom-left
                { x: 150, y: 150, id: 4 }   // Bottom-right
            ];
            
            // Common path patterns (realistic designs kids might make)
            const commonPatterns = [
                [0, 1, 2, 3, 4],  // Star pattern
                [0, 1, 4, 3, 0],  // Square (will have 5 when we add start point)
                [0, 2, 4, 2, 1],  // Zigzag
                [3, 2, 1, 2, 4],  // Symmetric
                [0, 1, 2, 4, 3],  // Random full
                [1, 2, 3, 2, 4],  // Cross
                [0, 3, 2, 4, 1],  // Complex
                [3, 0, 2, 1, 4],  // Diagonal
                [0, 2, 1, 4, 3],  // Wave
                [3, 4, 2, 0, 1],  // Reverse
                [0, 1, 3, 4, 2],  // Mixed
                [1, 4, 2, 3, 0],  // Alternate
                [0, 4, 1, 3, 2],  // Cross pattern
                [2, 0, 3, 1, 4],  // Center start
                [3, 2, 4, 1, 0],  // Bottom start
                [1, 0, 2, 4, 3],  // Top start
                [4, 1, 2, 3, 0],  // Corner start
                [2, 3, 0, 1, 4],  // Center cross
                [1, 3, 2, 0, 4],  // Lateral
                [4, 3, 2, 1, 0],  // Reverse diagonal
                [0, 2, 3, 4, 1],  // L-shape
                [1, 2, 4, 3, 0],  // M-shape
                [3, 1, 2, 4, 0],  // N-shape
                [4, 2, 0, 3, 1],  // X-pattern
                [2, 1, 4, 0, 3],  // Z-pattern
                [0, 3, 4, 1, 2],  // W-pattern
                [1, 0, 3, 2, 4],  // U-pattern
                [4, 0, 2, 3, 1],  // V-pattern
                [2, 4, 3, 0, 1],  // S-pattern
                [3, 4, 1, 2, 0]   // T-pattern
            ];
            
            // Incomplete patterns (for violations)
            const incompletePatterns = [
                [0, 1, 2],        // Only 3 dots
                [3, 2, 4],        // Only 3 dots
                [0, 1],           // Only 2 dots
                [2, 3, 1, 4],     // Only 4 dots
                [1, 4, 2],        // Only 3 dots
                [0, 2, 3],        // Only 3 dots
                [4, 3, 1, 0],     // Only 4 dots
                [2, 1, 4, 3]      // Only 4 dots
            ];
            
            let designCounter = 0;
            
            participants.forEach(participant => {
                // Total designs per participant should be ~40
                const totalDesignsForParticipant = 38 + Math.floor(Math.random() * 5); // 38-42 designs
                
                // Distribute designs across sessions
                const designsPerSession = Math.floor(totalDesignsForParticipant / participant.sessions);
                
                for (let sessionNum = 0; sessionNum < participant.sessions; sessionNum++) {
                    // Create session with realistic timing
                    const baseDate = new Date('2024-12-10');
                    baseDate.setDate(baseDate.getDate() + sessionNum); // Different days for different sessions
                    baseDate.setHours(9 + sessionNum * 5, 0, 0, 0); // Different times
                    
                    const signInTime = baseDate.getTime();
                    const signInDate = baseDate.toISOString();
                    const sessionId = `${participant.firstName}_${participant.lastName}_${signInTime}`;
                    
                    // Number of designs for this session
                    const numDesigns = sessionNum === participant.sessions - 1 
                        ? totalDesignsForParticipant - (designsPerSession * sessionNum) // Last session gets remaining
                        : designsPerSession;
                    
                    const usedPatternsInSession = new Set();
                    
                    for (let i = 0; i < numDesigns; i++) {
                        // 85% complete designs, 15% incomplete (violations)
                        const isComplete = Math.random() > 0.15;
                        const patternList = isComplete ? commonPatterns : incompletePatterns;
                        
                        // Check for repetition (8% chance after 5th design)
                        const isRepetition = i >= 5 && Math.random() < 0.08 && usedPatternsInSession.size > 0;
                        let selectedPattern;
                        
                        if (isRepetition) {
                            // Repeat a previous pattern from this session
                            const usedPatterns = Array.from(usedPatternsInSession);
                            const patternString = usedPatterns[Math.floor(Math.random() * usedPatterns.length)];
                            // Convert string back to array of numbers
                            selectedPattern = patternString.split(',').map(Number);
                        } else {
                            // Get a pattern that hasn't been used yet (if possible)
                            let attempts = 0;
                            do {
                                selectedPattern = patternList[Math.floor(Math.random() * patternList.length)];
                                attempts++;
                            } while (usedPatternsInSession.has(selectedPattern.join(',')) && attempts < 10);
                            
                            if (isComplete) { // Only track complete patterns for repetition
                                usedPatternsInSession.add(selectedPattern.join(','));
                            }
                        }
                        
                        const path = selectedPattern.map(id => dotPositions[id]);
                        
                        // Design timestamp (7-12 seconds apart for 40 designs in 5 minutes)
                        const timeBetweenDesigns = 7000 + Math.floor(Math.random() * 5000); // 7-12 seconds
                        const designTime = signInTime + (i * timeBetweenDesigns) + Math.floor(Math.random() * 2000);
                        const designDate = new Date(designTime).toISOString();
                        
                        // Determine violations
                        const violations = [];
                        let hasViolation = false;
                        
                        if (!isComplete) {
                            violations.push('incompleteLinesCount');
                            hasViolation = true;
                        }
                        
                        if (isRepetition) {
                            violations.push('repetition');
                            hasViolation = true;
                        }
                        
                        // Create design object with full metrics
                        const pathObj = selectedPattern.map(id => dotPositions[id]);
                        const pathLength = calculatePathLength(pathObj);
                        
                        // Determine strategy probabilities based on participant preference
                        let spatialChance = 0;
                        let numericalChance = 0;
                        
                        switch(participant.strategyPreference) {
                            case 'spatial':
                                spatialChance = 0.30;  // 30% chance for spatial
                                numericalChance = 0.05; // 5% chance for numerical
                                break;
                            case 'numerical':
                                spatialChance = 0.05;  // 5% chance for spatial
                                numericalChance = 0.30; // 30% chance for numerical
                                break;
                            case 'both':
                                spatialChance = 0.20;  // 20% chance for spatial
                                numericalChance = 0.20; // 20% chance for numerical
                                break;
                            case 'none':
                            default:
                                spatialChance = 0.02;  // 2% chance for spatial
                                numericalChance = 0.02; // 2% chance for numerical
                                break;
                        }
                        
                        // Check for spatial strategy (rotation/mirroring of previous design)
                        let spatialStrategy = null;
                        if (selectedPattern.length === 5 && allTimeDesigns.length > 0 && i > 0) {
                            if (Math.random() < spatialChance) {
                                const recentDesigns = allTimeDesigns.filter(d => d.sessionId === sessionId);
                                if (recentDesigns.length > 0) {
                                    const strategyTypes = ['rotation', 'mirror'];
                                    const transformations = {
                                        'rotation': ['90Â°', '180Â°', '270Â°'],
                                        'mirror': ['horizontal', 'vertical', 'diagonal1', 'diagonal2']
                                    };
                                    const type = strategyTypes[Math.floor(Math.random() * strategyTypes.length)];
                                    const transformation = transformations[type][Math.floor(Math.random() * transformations[type].length)];
                                    
                                    spatialStrategy = {
                                        type: type,
                                        transformation: transformation,
                                        originalDesignIndex: recentDesigns.length - 1
                                    };
                                }
                            }
                        }
                        
                        // Check for numerical strategy (adding/removing lines)
                        let numericalStrategy = null;
                        if (!spatialStrategy && allTimeDesigns.length > 0 && i > 0) {
                            if (Math.random() < numericalChance) {
                                const recentDesigns = allTimeDesigns.filter(d => d.sessionId === sessionId);
                                if (recentDesigns.length > 0) {
                                    const strategyTypes = ['addition', 'removal'];
                                    const transformations = {
                                        'addition': ['added line at end', 'added line at start', 'added 1 line'],
                                        'removal': ['removed line from end', 'removed line from start', 'removed 1 line']
                                    };
                                    const type = strategyTypes[Math.floor(Math.random() * strategyTypes.length)];
                                    const transformation = transformations[type][Math.floor(Math.random() * transformations[type].length)];
                                    
                                    numericalStrategy = {
                                        type: type,
                                        transformation: transformation,
                                        originalDesignIndex: recentDesigns.length - 1
                                    };
                                }
                            }
                        }
                        
                        const design = {
                            path: pathObj,
                            timestamp: designTime,
                            timestampISO: designDate,
                            sessionId: sessionId,
                            user: {
                                firstName: participant.firstName,
                                lastName: participant.lastName,
                                age: participant.age
                            },
                            signInTime: signInTime,
                            signInDate: signInDate,
                            hasViolation: hasViolation,
                            violations: violations,
                            // Additional detailed metrics
                            totalStrokes: 1,
                            trajectories: selectedPattern.length - 1,
                            pathLength: pathLength,
                            dotsConnected: selectedPattern.length,
                            isComplete: selectedPattern.length === 5,
                            isOriginal: !isRepetition,
                            repetitionCount: 0, // Will be calculated later
                            designPattern: selectedPattern.join('-'),
                            // Spatial strategy tracking
                            isSpatialStrategy: spatialStrategy !== null,
                            spatialStrategyType: spatialStrategy ? spatialStrategy.type : null,
                            spatialTransformation: spatialStrategy ? spatialStrategy.transformation : null,
                            spatialOriginalIndex: spatialStrategy ? spatialStrategy.originalDesignIndex : null,
                            // Numerical strategy tracking
                            isNumericalStrategy: numericalStrategy !== null,
                            numericalStrategyType: numericalStrategy ? numericalStrategy.type : null,
                            numericalTransformation: numericalStrategy ? numericalStrategy.transformation : null,
                            numericalOriginalIndex: numericalStrategy ? numericalStrategy.originalDesignIndex : null
                        };
                        
                        allTimeDesigns.push(design);
                        designCounter++;
                    }
                }
            });
            
            // Update repetition counts for all designs
            updateRepetitionCounts();
            
            // Save to localStorage
            saveDesignHistory();
            
            // Verify the data was saved correctly
            console.log('All time designs after generation:', allTimeDesigns.length);
            console.log('First design:', allTimeDesigns[0]);
            console.log('Last design:', allTimeDesigns[allTimeDesigns.length - 1]);
            
            // Count spatial strategies
            const spatialCount = allTimeDesigns.filter(d => d.isSpatialStrategy).length;
            const numericalCount = allTimeDesigns.filter(d => d.isNumericalStrategy).length;
            console.log('Spatial strategy designs:', spatialCount);
            console.log('Numerical strategy designs:', numericalCount);
            
            // Verify localStorage
            const savedData = localStorage.getItem('fivePointTestHistory');
            console.log('Saved to localStorage:', savedData ? JSON.parse(savedData).length + ' designs' : 'NOTHING SAVED!');
            
            alert(`Demo data generated!\n\n${participants.length} participants\n${participants.reduce((sum, p) => sum + p.sessions, 0)} sessions\n${designCounter} total designs (~${Math.round(designCounter/participants.length)} per participant)\n\nðŸ”„ Spatial strategies: ${spatialCount}\nâž• Numerical strategies: ${numericalCount}\n\nParticipant Strategy Preferences:\nâ€¢ Antoine: Spatial\nâ€¢ Lea: Numerical\nâ€¢ Gabriel: Both\nâ€¢ Emma: None\nâ€¢ Mathieu: Numerical\n\nLogin as admin to view.`);
            
            console.log(`Generated ${designCounter} designs for ${participants.length} participants`);
            
            } catch (error) {
                console.error('Error generating demo data:', error);
                alert('Error generating demo data: ' + error.message);
            }
        }

        // Add demo data button on page load (for development)
        window.addEventListener('DOMContentLoaded', function() {
            // Only show demo button if in development mode
            // Remove this in production
            const demoBtn = document.createElement('button');
            demoBtn.textContent = 'ðŸŽ¨ Generate Demo Data';
            demoBtn.style.cssText = 'position: fixed; bottom: 20px; right: 20px; z-index: 9999; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);';
            demoBtn.onclick = generateDemoData;
            document.body.appendChild(demoBtn);
        });

        // Violation prompt functions
        function showViolationPrompt(violationTypes) {
            // violationTypes can be a single string or an array of strings
            if (!Array.isArray(violationTypes)) {
                violationTypes = [violationTypes];
            }
            
            // Filter out violations that have already been shown
            const newViolations = violationTypes.filter(type => !violationsShown[type]);
            
            if (newViolations.length === 0) {
                return; // All violations already shown
            }
            
            // Mark these violations as shown
            newViolations.forEach(type => {
                violationsShown[type] = true;
            });
            
            // Build the message for all new violations
            const messages = newViolations.map(type => {
                switch(type) {
                    case 'strayLine':
                        return 'Each line must connect one dot to another dot.';
                    case 'repetition':
                        return 'You must not repeat any design you have already drawn.';
                    case 'disconnectedLines':
                        return 'When you lift your finger, your next line must start from where you ended.';
                    case 'incompleteLinesCount':
                        return 'A valid design must connect all 5 dots with 4 continuous lines.';
                    default:
                        return '';
                }
            }).filter(msg => msg !== '');
            
            if (messages.length === 0) return;
            
            // Combine messages
            let finalMessage = messages.length === 1 
                ? `Remember: ${messages[0]}` 
                : `Remember:\nâ€¢ ${messages.join('\nâ€¢ ')}`;
            
            document.getElementById('violationMessage').textContent = finalMessage;
            document.getElementById('violationOverlay').classList.add('active');
            document.getElementById('violationPrompt').classList.add('active');
            
            // Start 30-second countdown
            let timeLeft = 30;
            document.getElementById('timerSeconds').textContent = timeLeft;
            
            violationCountdown = setInterval(() => {
                timeLeft--;
                document.getElementById('timerSeconds').textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    dismissViolation();
                }
            }, 1000);
            
            // Auto-dismiss after 30 seconds
            violationTimer = setTimeout(() => {
                dismissViolation();
            }, 30000);
        }

        function dismissViolation() {
            clearTimeout(violationTimer);
            clearInterval(violationCountdown);
            document.getElementById('violationOverlay').classList.remove('active');
            document.getElementById('violationPrompt').classList.remove('active');
        }

        // Check if path connects dots properly (no stray lines)
        function hasStrayLines(path) {
            // All points in path should be from our dots array
            return false; // Our current implementation already ensures this
        }

        // Check if design is a repetition
        function isRepetition(newPath) {
            const newPathStr = pathToString(newPath);
            for (let design of completedDesigns) {
                if (pathToString(design.path) === newPathStr) {
                    return true;
                }
            }
            return false;
        }

        // Spatial Strategy Detection (Rotation/Mirroring)
        // Check if a design is a rotation or mirror of another design
        function detectSpatialStrategy(path1, path2) {
            if (!path1 || !path2 || path1.length !== path2.length) return null;
            
            // Get the pattern as dot IDs
            const ids1 = path1.map(p => p.id);
            const ids2 = path2.map(p => p.id);
            
            // Define rotation mappings (90Â°, 180Â°, 270Â° clockwise)
            // Dot positions: 0=TL, 1=TR, 2=Center, 3=BL, 4=BR
            const rotations = {
                '90': { 0: 1, 1: 4, 2: 2, 3: 0, 4: 3 },   // 90Â° clockwise
                '180': { 0: 4, 1: 3, 2: 2, 3: 1, 4: 0 },  // 180Â°
                '270': { 0: 3, 1: 0, 2: 2, 3: 4, 4: 1 }   // 270Â° clockwise
            };
            
            // Define mirror mappings
            const mirrors = {
                'horizontal': { 0: 1, 1: 0, 2: 2, 3: 4, 4: 3 },  // Mirror left-right
                'vertical': { 0: 3, 1: 4, 2: 2, 3: 0, 4: 1 },    // Mirror top-bottom
                'diagonal1': { 0: 0, 1: 3, 2: 2, 3: 1, 4: 4 },   // Mirror along TL-BR diagonal
                'diagonal2': { 0: 4, 1: 1, 2: 2, 3: 3, 4: 0 }    // Mirror along TR-BL diagonal
            };
            
            // Check all rotations
            for (let [angle, mapping] of Object.entries(rotations)) {
                const rotated = ids1.map(id => mapping[id]);
                if (arraysEqual(rotated, ids2)) {
                    return { type: 'rotation', transformation: angle + 'Â°' };
                }
                // Also check reversed path
                if (arraysEqual(rotated.reverse(), ids2)) {
                    return { type: 'rotation', transformation: angle + 'Â° (reversed)' };
                }
            }
            
            // Check all mirrors
            for (let [axis, mapping] of Object.entries(mirrors)) {
                const mirrored = ids1.map(id => mapping[id]);
                if (arraysEqual(mirrored, ids2)) {
                    return { type: 'mirror', transformation: axis };
                }
                // Also check reversed path
                if (arraysEqual(mirrored.reverse(), ids2)) {
                    return { type: 'mirror', transformation: axis + ' (reversed)' };
                }
            }
            
            return null;
        }
        
        // Helper function to compare arrays
        function arraysEqual(arr1, arr2) {
            if (arr1.length !== arr2.length) return false;
            for (let i = 0; i < arr1.length; i++) {
                if (arr1[i] !== arr2[i]) return false;
            }
            return true;
        }
        
        // Check if current design is a spatial transformation of any previous design
        function findSpatialStrategy(currentPath, previousDesigns) {
            for (let i = previousDesigns.length - 1; i >= 0; i--) {
                const prevDesign = previousDesigns[i];
                if (!prevDesign.path) continue;
                
                const strategy = detectSpatialStrategy(prevDesign.path, currentPath);
                if (strategy) {
                    return {
                        ...strategy,
                        originalDesignIndex: i,
                        originalDesign: prevDesign
                    };
                }
            }
            return null;
        }

        // Numerical Strategy Detection (Line Addition/Removal)
        // Check if a design is created by adding or removing a line from a previous design
        function detectNumericalStrategy(path1, path2) {
            if (!path1 || !path2) return null;
            
            // Get the pattern as dot IDs
            const ids1 = path1.map(p => p.id);
            const ids2 = path2.map(p => p.id);
            
            // Check for line addition (path2 has one more dot than path1)
            if (ids2.length === ids1.length + 1) {
                // Check if all dots from path1 are in path2 (in same order or extended)
                let isAddition = false;
                
                // Check if path1 is a prefix of path2 (line added at end)
                if (arraysStartWith(ids2, ids1)) {
                    return { type: 'addition', transformation: 'added line at end' };
                }
                
                // Check if path1 is a suffix of path2 (line added at start)
                if (arraysEndWith(ids2, ids1)) {
                    return { type: 'addition', transformation: 'added line at start' };
                }
                
                // Check if path1 dots are subset of path2 dots
                const set1 = new Set(ids1);
                const set2 = new Set(ids2);
                let allIn = true;
                for (let id of set1) {
                    if (!set2.has(id)) {
                        allIn = false;
                        break;
                    }
                }
                if (allIn && set2.size === set1.size + 1) {
                    return { type: 'addition', transformation: 'added 1 line' };
                }
            }
            
            // Check for line removal (path2 has one less dot than path1)
            if (ids2.length === ids1.length - 1) {
                // Check if path2 is a prefix of path1 (line removed from end)
                if (arraysStartWith(ids1, ids2)) {
                    return { type: 'removal', transformation: 'removed line from end' };
                }
                
                // Check if path2 is a suffix of path1 (line removed from start)
                if (arraysEndWith(ids1, ids2)) {
                    return { type: 'removal', transformation: 'removed line from start' };
                }
                
                // Check if path2 dots are subset of path1 dots
                const set1 = new Set(ids1);
                const set2 = new Set(ids2);
                let allIn = true;
                for (let id of set2) {
                    if (!set1.has(id)) {
                        allIn = false;
                        break;
                    }
                }
                if (allIn && set1.size === set2.size + 1) {
                    return { type: 'removal', transformation: 'removed 1 line' };
                }
            }
            
            return null;
        }
        
        // Helper: Check if arr1 starts with arr2
        function arraysStartWith(arr1, arr2) {
            if (arr2.length > arr1.length) return false;
            for (let i = 0; i < arr2.length; i++) {
                if (arr1[i] !== arr2[i]) return false;
            }
            return true;
        }
        
        // Helper: Check if arr1 ends with arr2
        function arraysEndWith(arr1, arr2) {
            if (arr2.length > arr1.length) return false;
            const offset = arr1.length - arr2.length;
            for (let i = 0; i < arr2.length; i++) {
                if (arr1[offset + i] !== arr2[i]) return false;
            }
            return true;
        }
        
        // Check if current design is a numerical transformation of any previous design
        function findNumericalStrategy(currentPath, previousDesigns) {
            for (let i = previousDesigns.length - 1; i >= 0; i--) {
                const prevDesign = previousDesigns[i];
                if (!prevDesign.path) continue;
                
                const strategy = detectNumericalStrategy(prevDesign.path, currentPath);
                if (strategy) {
                    return {
                        ...strategy,
                        originalDesignIndex: i,
                        originalDesign: prevDesign
                    };
                }
            }
            return null;
        }

        // Calculate the total length of a path
        function calculatePathLength(path) {
            if (path.length < 2) return 0;
            
            let totalLength = 0;
            for (let i = 1; i < path.length; i++) {
                const dx = path[i].x - path[i-1].x;
                const dy = path[i].y - path[i-1].y;
                totalLength += Math.sqrt(dx * dx + dy * dy);
            }
            return Math.round(totalLength * 100) / 100; // Round to 2 decimal places
        }

        // Update repetition counts for all designs
        function updateRepetitionCounts() {
            const patternCounts = {};
            
            // Count occurrences of each pattern
            allTimeDesigns.forEach(design => {
                const pattern = design.designPattern || pathToString(design.path);
                patternCounts[pattern] = (patternCounts[pattern] || 0) + 1;
            });
            
            // Update repetition count for each design
            allTimeDesigns.forEach(design => {
                const pattern = design.designPattern || pathToString(design.path);
                design.repetitionCount = patternCounts[pattern] - 1; // Subtract 1 (don't count itself)
            });
            
            // Also update completedDesigns
            completedDesigns.forEach(design => {
                const pattern = design.designPattern || pathToString(design.path);
                design.repetitionCount = patternCounts[pattern] - 1;
            });
        }

        // Calculate statistics for a participant
        function calculateParticipantStats(designs) {
            const stats = {
                totalDesigns: designs.length,
                uniqueDesigns: 0,
                repeatedDesigns: 0,
                originalDesigns: 0,
                totalViolations: 0,
                violationsByType: {
                    incompleteLinesCount: 0,
                    repetition: 0,
                    disconnectedLines: 0,
                    strayLine: 0
                },
                averagePathLength: 0,
                averageDotsConnected: 0,
                completeDesigns: 0,
                incompleteDesigns: 0,
                // Spatial strategy stats
                spatialStrategyCount: 0,
                rotationCount: 0,
                mirrorCount: 0,
                // Numerical strategy stats
                numericalStrategyCount: 0,
                additionCount: 0,
                removalCount: 0
            };
            
            const uniquePatterns = new Set();
            let totalPathLength = 0;
            let totalDotsConnected = 0;
            
            designs.forEach(design => {
                const pattern = design.designPattern || pathToString(design.path);
                uniquePatterns.add(pattern);
                
                if (design.isOriginal !== false) { // Count as original if not explicitly marked
                    stats.uniqueDesigns++;
                } else {
                    stats.repeatedDesigns++;
                }
                
                // Count first original designs (not a strategy, not a violation, not a repeat)
                if (design.isOriginal !== false && 
                    !design.isSpatialStrategy && 
                    !design.isNumericalStrategy && 
                    !design.hasViolation) {
                    stats.originalDesigns++;
                }
                
                if (design.hasViolation) {
                    stats.totalViolations++;
                    if (design.violations) {
                        design.violations.forEach(v => {
                            if (stats.violationsByType[v] !== undefined) {
                                stats.violationsByType[v]++;
                            }
                        });
                    }
                }
                
                if (design.pathLength) {
                    totalPathLength += design.pathLength;
                }
                
                if (design.dotsConnected) {
                    totalDotsConnected += design.dotsConnected;
                }
                
                if (design.isComplete || design.dotsConnected === 5) {
                    stats.completeDesigns++;
                } else {
                    stats.incompleteDesigns++;
                }
                
                // Count spatial strategies
                if (design.isSpatialStrategy) {
                    stats.spatialStrategyCount++;
                    if (design.spatialStrategyType === 'rotation') {
                        stats.rotationCount++;
                    } else if (design.spatialStrategyType === 'mirror') {
                        stats.mirrorCount++;
                    }
                }
                
                // Count numerical strategies
                if (design.isNumericalStrategy) {
                    stats.numericalStrategyCount++;
                    if (design.numericalStrategyType === 'addition') {
                        stats.additionCount++;
                    } else if (design.numericalStrategyType === 'removal') {
                        stats.removalCount++;
                    }
                }
            });
            
            stats.uniqueDesigns = uniquePatterns.size;
            stats.averagePathLength = designs.length > 0 ? Math.round((totalPathLength / designs.length) * 100) / 100 : 0;
            stats.averageDotsConnected = designs.length > 0 ? Math.round((totalDotsConnected / designs.length) * 10) / 10 : 0;
            
            return stats;
        }

        // Check if design has exactly 4 lines (all 5 points connected)
        function hasIncompleteLinesCount(path) {
            // A valid design must connect all 5 dots with 4 continuous lines
            // This means the path must have exactly 5 dots
            return path.length !== 5;
        }

        // Check if user lifted finger and restarted from wrong point
        function hasDisconnectedLines(path) {
            // Our drawing mechanism already ensures continuous connection
            // because we only add dots when dragging in one continuous motion
            // This check is just a safeguard
            return false;
        }

        // Track the last dot of previous drawing session
        let lastDrawingEndDot = null;
        let isNewDesignStarted = false;
        let autoSaveTimer = null;

        // Load design history from localStorage
        function loadDesignHistory() {
            try {
                const saved = localStorage.getItem('fivePointTestHistory');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    allTimeDesigns = parsed.map(design => ({
                        ...design,
                        date: new Date(design.timestamp)
                    }));
                    console.log(`Loaded ${allTimeDesigns.length} designs from history`);
                }
            } catch (e) {
                console.error('Error loading design history:', e);
                allTimeDesigns = [];
            }
        }

        // Save design history to localStorage
        function saveDesignHistory() {
            try {
                localStorage.setItem('fivePointTestHistory', JSON.stringify(allTimeDesigns));
                console.log(`Saved ${allTimeDesigns.length} designs to history`);
            } catch (e) {
                console.error('Error saving design history:', e);
            }
        }

        // Check if design exists in all-time history
        function isDesignInHistory(newPath) {
            const newPathStr = pathToString(newPath);
            return allTimeDesigns.some(design => {
                const historyPathStr = pathToString(design.path);
                return historyPathStr === newPathStr;
            });
        }

        function setupCanvas() {
            canvas.width = CANVAS_SIZE;
            canvas.height = CANVAS_SIZE;
            
            // Calculate actual dot positions
            dots = DOT_POSITIONS.map(pos => ({
                x: pos.x * CANVAS_SIZE,
                y: pos.y * CANVAS_SIZE,
                id: pos.id
            }));
            
            drawCanvas();
            
            // Event listeners
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', endDrawing);
            canvas.addEventListener('mouseleave', endDrawing);
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', handleTouchEnd, { passive: false });
            canvas.addEventListener('touchcancel', handleTouchEnd, { passive: false });
        }

        function drawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw border
            ctx.strokeStyle = '#999';
            ctx.lineWidth = 2;
            ctx.strokeRect(0, 0, canvas.width, canvas.height);
            
            // Draw dots (5 points like a die)
            dots.forEach(dot => {
                ctx.fillStyle = '#2196F3';
                ctx.beginPath();
                ctx.arc(dot.x, dot.y, DOT_RADIUS, 0, Math.PI * 2);
                ctx.fill();
            });
            
            // Redraw current path
            if (currentPath.length > 0) {
                drawPath(currentPath, '#4CAF50', 4);
            }
        }

        function drawPath(path, color, width) {
            if (path.length < 2) return;
            
            ctx.strokeStyle = color;
            ctx.lineWidth = width;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            ctx.beginPath();
            ctx.moveTo(path[0].x, path[0].y);
            for (let i = 1; i < path.length; i++) {
                ctx.lineTo(path[i].x, path[i].y);
            }
            ctx.stroke();
        }

        function getNearestDot(x, y) {
            let nearest = null;
            let minDist = CANVAS_SIZE * 0.15; // Snap distance
            
            dots.forEach(dot => {
                const dist = Math.sqrt((x - dot.x) ** 2 + (y - dot.y) ** 2);
                if (dist < minDist) {
                    minDist = dist;
                    nearest = dot;
                }
            });
            
            return nearest;
        }

        function startDrawing(e) {
            if (!isTestActive) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);
            
            const dot = getNearestDot(x, y);
            if (dot) {
                // Check if this is a continuation or new design
                if (currentPath.length > 0 && lastDrawingEndDot !== null) {
                    // User is trying to continue - check if starting from last end point
                    if (dot.id !== lastDrawingEndDot.id) {
                        // VIOLATION: Not starting from where they left off
                        showViolationPrompt('disconnectedLines');
                        return; // Don't allow this drawing
                    }
                }
                
                isDrawing = true;
                isNewDesignStarted = false;
                
                // If starting fresh, add the dot
                if (currentPath.length === 0) {
                    currentPath = [dot];
                    isNewDesignStarted = true;
                }
                
                drawCanvas();
            }
        }

        function draw(e) {
            if (!isDrawing || !isTestActive) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);
            
            const dot = getNearestDot(x, y);
            if (dot && !currentPath.find(d => d.id === dot.id)) {
                currentPath.push(dot);
                playSound('connect');
                drawCanvas();
                
                // Check if design is complete (all 5 dots connected)
                if (currentPath.length === 5) {
                    // Clear any existing auto-save timer
                    if (autoSaveTimer) {
                        clearTimeout(autoSaveTimer);
                    }
                    
                    // Set timer to auto-save after 1 second
                    autoSaveTimer = setTimeout(() => {
                        if (currentPath.length === 5 && isTestActive) {
                            nextDesign();
                        }
                    }, 1000);
                }
            }
        }

        function endDrawing() {
            if (isDrawing && currentPath.length >= 2) {
                isDrawing = false;
                
                // Track where this drawing ended (for continuation check)
                lastDrawingEndDot = currentPath[currentPath.length - 1];
                
                // Don't auto-save - user must press "Next Design" button
            } else {
                isDrawing = false;
            }
        }

        function handleTouchStart(e) {
            e.preventDefault();
            e.stopPropagation();
            if (e.touches.length > 0) {
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                
                // Directly call startDrawing with touch coordinates
                const fakeEvent = { 
                    offsetX: x, 
                    offsetY: y,
                    preventDefault: function() {}
                };
                startDrawing(fakeEvent);
            }
        }

        function handleTouchMove(e) {
            e.preventDefault();
            e.stopPropagation();
            if (e.touches.length > 0) {
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                
                // Directly call draw with touch coordinates
                const fakeEvent = { 
                    offsetX: x, 
                    offsetY: y,
                    preventDefault: function() {}
                };
                draw(fakeEvent);
            }
        }

        function handleTouchEnd(e) {
            e.preventDefault();
            e.stopPropagation();
            endDrawing();
        }

        function startTest() {
            if (isTestActive) return;
            
            // Show custom ready modal
            document.getElementById('readyModal').classList.add('active');
        }

        function confirmStart() {
            // Hide modal
            document.getElementById('readyModal').classList.remove('active');
            
            // Use fixed 5 minute duration
            timer = TEST_DURATION;
            
            isTestActive = true;
            isPaused = false;
            completedDesigns = [];
            updateStats();
            initializeDesignsGrid();
            
            // Update timer display
            const minutes = Math.floor(timer / 60);
            const seconds = timer % 60;
            document.getElementById('timer').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Show and reset progress bar
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('progressFill').style.width = '100%';
            document.getElementById('progressFill').className = 'progress-fill';
            document.getElementById('progressPercent').textContent = '100%';
            
            document.getElementById('startBtn').classList.add('btn-disabled');
            
            timerInterval = setInterval(updateTimer, 1000);
        }

        function cancelStart() {
            // Hide modal
            document.getElementById('readyModal').classList.remove('active');
        }

        function togglePause() {
            if (!isTestActive) return;
            
            isPaused = !isPaused;
            document.getElementById('pauseBtn').textContent = isPaused ? 'Resume' : 'Pause';
            
            if (isPaused) {
                clearInterval(timerInterval);
            } else {
                timerInterval = setInterval(updateTimer, 1000);
            }
        }

        function updateTimer() {
            timer--;
            
            const minutes = Math.floor(timer / 60);
            const seconds = timer % 60;
            const timerEl = document.getElementById('timer');
            timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Update progress bar
            updateProgressBar();
            
            if (timer <= 0) {
                endTest();
            }
        }

        function endTest() {
            isTestActive = false;
            isPaused = false;
            clearInterval(timerInterval);
            
            // Save the current design if user was drawing
            if (currentPath.length >= 2) {
                // Save current incomplete design
                const designCanvas = document.createElement('canvas');
                designCanvas.width = CANVAS_SIZE;
                designCanvas.height = CANVAS_SIZE;
                const designCtx = designCanvas.getContext('2d');
                
                // Draw border
                designCtx.strokeStyle = '#ccc';
                designCtx.lineWidth = 1;
                designCtx.strokeRect(0, 0, designCanvas.width, designCanvas.height);
                
                // Copy dots
                dots.forEach(dot => {
                    designCtx.fillStyle = '#2196F3';
                    designCtx.beginPath();
                    designCtx.arc(dot.x, dot.y, DOT_RADIUS * 0.8, 0, Math.PI * 2);
                    designCtx.fill();
                });
                
                // Copy path
                designCtx.strokeStyle = '#4CAF50';
                designCtx.lineWidth = 3;
                designCtx.lineCap = 'round';
                designCtx.lineJoin = 'round';
                designCtx.beginPath();
                designCtx.moveTo(currentPath[0].x, currentPath[0].y);
                for (let i = 1; i < currentPath.length; i++) {
                    designCtx.lineTo(currentPath[i].x, currentPath[i].y);
                }
                designCtx.stroke();
                
                const designData = {
                    canvas: designCanvas,
                    path: [...currentPath],
                    timestamp: Date.now(),
                    timestampISO: new Date().toISOString(),
                    sessionId: sessionId,
                    user: {
                        firstName: currentUser.firstName,
                        lastName: currentUser.lastName,
                        age: currentUser.age
                    },
                    hasViolation: false
                };
                
                completedDesigns.push(designData);
                
                // Add to all-time history with full metadata
                allTimeDesigns.push({
                    path: [...currentPath],
                    timestamp: Date.now(),
                    timestampISO: new Date().toISOString(),
                    sessionId: sessionId,
                    user: {
                        firstName: currentUser.firstName,
                        lastName: currentUser.lastName,
                        age: currentUser.age
                    },
                    signInTime: currentUser.signInTime,
                    signInDate: currentUser.signInDate,
                    hasViolation: false,
                    violations: []
                });
                saveDesignHistory();
                
                currentPath = [];
                updateStats();
                updateDesignsGrid();
            }
            
            // Show results screen instead of old screen lock
            showResults();
        }

        function finalizeTest() {
            // Close the screen lock
            document.getElementById('screenLock').classList.remove('active');
            
            // Auto-download session data before returning to sign-in
            if (currentUser && completedDesigns.length > 0) {
                downloadSessionData();
            }
            
            // Hide main container
            document.querySelector('.container').style.display = 'none';
            
            // Re-enable start button for next test
            document.getElementById('startBtn').classList.remove('btn-disabled');
            
            // Clear the form fields
            document.getElementById('firstName').value = '';
            document.getElementById('lastName').value = '';
            document.getElementById('age').value = '';
            
            // Reset current user
            currentUser = null;
            
            // Return to sign-in page
            document.getElementById('signinScreen').classList.remove('hidden');
            document.getElementById('signinScreen').style.display = 'flex';
        }

        function downloadSessionData() {
            // Create session data object
            const sessionData = {
                participant: {
                    firstName: currentUser.firstName,
                    lastName: currentUser.lastName,
                    age: currentUser.age
                },
                sessionId: sessionId,
                signInTime: currentUser.signInTime,
                signInDate: currentUser.signInDate,
                testEndTime: Date.now(),
                testEndDate: new Date().toISOString(),
                totalDesigns: completedDesigns.length,
                designsWithViolations: completedDesigns.filter(d => d.hasViolation).length,
                designs: completedDesigns.map((design, index) => ({
                    designNumber: index + 1,
                    timestamp: design.timestamp,
                    timestampISO: design.timestampISO,
                    path: design.path,
                    dotsConnected: design.path ? design.path.length : 0,
                    hasViolation: design.hasViolation || false,
                    violations: design.violations || []
                }))
            };
            
            // Create filename with timestamp
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            const filename = `AppFLO_${currentUser.firstName}_${currentUser.lastName}_${timestamp}.json`;
            
            // Convert to JSON and download
            const dataStr = JSON.stringify(sessionData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
            
            console.log(`Session data auto-downloaded: ${filename}`);
        }

        function clearCurrentDesign() {
            // Clear auto-save timer
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
                autoSaveTimer = null;
            }
            
            currentPath = [];
            lastDrawingEndDot = null;
            drawCanvas();
        }

        function pathToString(path) {
            // Create a string based on the EXACT sequence of dot IDs
            // This means the same shape drawn in a different order OR rotated = DIFFERENT design
            // Only exact same drawing (same dots in same order, or reversed) = SAME design
            
            if (!path || path.length < 2) return '';
            
            // Get the sequence of dot IDs
            const ids = path.map(p => p.id);
            const forward = ids.join('-');
            const backward = ids.slice().reverse().join('-');
            
            // Return the lexicographically smaller one for consistency
            // This way 0-1-2 and 2-1-0 are considered the same
            return forward < backward ? forward : backward;
        }

        function arePathsSimilar(path1, path2) {
            if (path1.length !== path2.length) return false;
            
            const str1 = pathToString(path1);
            const str2 = pathToString(path2);
            
            return str1 === str2;
        }

        function checkForDuplicate(newPath) {
            // Check current session
            for (let design of completedDesigns) {
                if (arePathsSimilar(newPath, design.path)) {
                    return true;
                }
            }
            
            // Check all-time history
            return isDesignInHistory(newPath);
        }

        function nextDesign() {
            if (!isTestActive || currentPath.length < 2) {
                if (currentPath.length > 0 && currentPath.length < 2) {
                    alert('Please connect at least 2 dots before submitting.');
                }
                return;
            }
            
            // Play save sound
            playSound('save');
            
            // Clear auto-save timer if it exists
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
                autoSaveTimer = null;
            }
            
            // Check for all violations
            let violations = [];
            let hasViolation = false;
            
            // Check for incomplete lines count (must have all 5 dots connected with 4 lines)
            if (hasIncompleteLinesCount(currentPath)) {
                violations.push('incompleteLinesCount');
                hasViolation = true;
            }
            
            // Check for repetition (perseveration)
            if (isRepetition(currentPath)) {
                violations.push('repetition');
                hasViolation = true;
            }
            
            // Show all violations at once if any exist
            if (violations.length > 0) {
                showViolationPrompt(violations);
            }
            
            // Still save the design even with violations
            // Save current design
            const designCanvas = document.createElement('canvas');
            designCanvas.width = CANVAS_SIZE;
            designCanvas.height = CANVAS_SIZE;
            const designCtx = designCanvas.getContext('2d');
            
            // Draw border
            designCtx.strokeStyle = '#ccc';
            designCtx.lineWidth = 1;
            designCtx.strokeRect(0, 0, designCanvas.width, designCanvas.height);
            
            // Copy dots
            dots.forEach(dot => {
                designCtx.fillStyle = '#2196F3';
                designCtx.beginPath();
                designCtx.arc(dot.x, dot.y, DOT_RADIUS * 0.8, 0, Math.PI * 2);
                designCtx.fill();
            });
            
            // Copy path - always green
            designCtx.strokeStyle = '#4CAF50';
            designCtx.lineWidth = 3;
            designCtx.lineCap = 'round';
            designCtx.lineJoin = 'round';
            designCtx.beginPath();
            designCtx.moveTo(currentPath[0].x, currentPath[0].y);
            for (let i = 1; i < currentPath.length; i++) {
                designCtx.lineTo(currentPath[i].x, currentPath[i].y);
            }
            designCtx.stroke();
            
            // Check for spatial strategy (rotation/mirroring of previous design)
            const spatialStrategy = findSpatialStrategy(currentPath, completedDesigns);
            
            // Check for numerical strategy (adding/removing lines)
            const numericalStrategy = !spatialStrategy ? findNumericalStrategy(currentPath, completedDesigns) : null;
            
            const designData = {
                canvas: designCanvas,
                path: [...currentPath],
                timestamp: Date.now(),
                timestampISO: new Date().toISOString(),
                sessionId: sessionId,
                user: {
                    firstName: currentUser.firstName,
                    lastName: currentUser.lastName,
                    age: currentUser.age
                },
                hasViolation: hasViolation,
                violations: violations,
                // Additional metrics
                totalStrokes: 1, // This design was completed in strokes (will track in future)
                trajectories: currentPath.length - 1, // Number of line segments
                pathLength: calculatePathLength(currentPath),
                dotsConnected: currentPath.length,
                isComplete: currentPath.length === 5,
                isOriginal: !isRepetition(currentPath),
                repetitionCount: 0, // Will be updated when checking duplicates
                designPattern: pathToString(currentPath),
                // Spatial strategy tracking
                isSpatialStrategy: spatialStrategy !== null,
                spatialStrategyType: spatialStrategy ? spatialStrategy.type : null,
                spatialTransformation: spatialStrategy ? spatialStrategy.transformation : null,
                spatialOriginalIndex: spatialStrategy ? spatialStrategy.originalDesignIndex : null,
                // Numerical strategy tracking
                isNumericalStrategy: numericalStrategy !== null,
                numericalStrategyType: numericalStrategy ? numericalStrategy.type : null,
                numericalTransformation: numericalStrategy ? numericalStrategy.transformation : null,
                numericalOriginalIndex: numericalStrategy ? numericalStrategy.originalDesignIndex : null
            };
            
            completedDesigns.push(designData);
            
            // Add to all-time history with full metadata
            allTimeDesigns.push({
                path: [...currentPath],
                timestamp: Date.now(),
                timestampISO: new Date().toISOString(),
                sessionId: sessionId,
                user: {
                    firstName: currentUser.firstName,
                    lastName: currentUser.lastName,
                    age: currentUser.age
                },
                signInTime: currentUser.signInTime,
                signInDate: currentUser.signInDate,
                hasViolation: hasViolation,
                violations: violations,
                // Additional metrics
                totalStrokes: 1,
                trajectories: currentPath.length - 1,
                pathLength: calculatePathLength(currentPath),
                dotsConnected: currentPath.length,
                isComplete: currentPath.length === 5,
                isOriginal: !isRepetition(currentPath),
                repetitionCount: 0,
                designPattern: pathToString(currentPath),
                // Spatial strategy tracking
                isSpatialStrategy: spatialStrategy !== null,
                spatialStrategyType: spatialStrategy ? spatialStrategy.type : null,
                spatialTransformation: spatialStrategy ? spatialStrategy.transformation : null,
                spatialOriginalIndex: spatialStrategy ? spatialStrategy.originalDesignIndex : null,
                // Numerical strategy tracking
                isNumericalStrategy: numericalStrategy !== null,
                numericalStrategyType: numericalStrategy ? numericalStrategy.type : null,
                numericalTransformation: numericalStrategy ? numericalStrategy.transformation : null,
                numericalOriginalIndex: numericalStrategy ? numericalStrategy.originalDesignIndex : null
            });
            
            // Update repetition counts for all designs with same pattern
            updateRepetitionCounts();
            
            saveDesignHistory();
            
            // Reset for new design
            currentPath = [];
            lastDrawingEndDot = null; // Reset tracking
            isNewDesignStarted = false;
            
            drawCanvas();
            updateStats();
            updateDesignsGrid();
        }

        function updateStats() {
            document.getElementById('totalCount').textContent = completedDesigns.length;
            document.getElementById('currentBox').textContent = completedDesigns.length + 1;
        }

        function initializeDesignsGrid() {
            const grid = document.getElementById('designsGrid');
            grid.innerHTML = '';
        }

        function updateDesignsGrid() {
            const grid = document.getElementById('designsGrid');
            grid.innerHTML = '';
            
            completedDesigns.forEach((design, index) => {
                const item = document.createElement('div');
                item.className = 'design-item';
                
                const number = document.createElement('div');
                number.className = 'design-number';
                number.textContent = `${index + 1}`;
                
                const miniCanvas = design.canvas.cloneNode(true);
                
                item.appendChild(number);
                item.appendChild(miniCanvas);
                grid.appendChild(item);
            });
        }

        function viewHistory() {
            if (allTimeDesigns.length === 0) {
                alert('No design history found. Create some designs first!');
                return;
            }
            
            const message = `Design History\n\nTotal designs ever created: ${allTimeDesigns.length}\n\nThis includes all designs from all test sessions.\n\nWould you like to clear the history?`;
            
            if (confirm(message)) {
                if (confirm('Are you sure? This will permanently delete all stored designs.')) {
                    allTimeDesigns = [];
                    saveDesignHistory();
                    updateStats();
                    alert('History cleared!');
                }
            }
        }

        function resetTest() {
            if (isTestActive && !confirm('Are you sure you want to reset the test?')) {
                return;
            }
            
            isTestActive = false;
            isPaused = false;
            TEST_DURATION = getRandomDuration();
            timer = TEST_DURATION;
            completedDesigns = [];
            currentPath = [];
            
            clearInterval(timerInterval);
            
            document.getElementById('startBtn').classList.remove('btn-disabled');
            
            const timerEl = document.getElementById('timer');
            timerEl.textContent = '--:--';
            timerEl.classList.remove('warning', 'danger');
            
            updateStats();
            initializeDesignsGrid();
            drawCanvas();
        }
    </script>
</body>
</html>
